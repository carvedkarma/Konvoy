{% extends "base.html" %}

{% block title %}Surge Map Predictor - RizTar{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <div class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-zinc-900 mb-2">Surge Map Predictor</h1>
            <p class="text-zinc-500">Predicted surge multipliers across Perth based on live patterns</p>
        </div>
        <div id="overall-surge" class="bg-white p-4 rounded-2xl shadow-sm border border-zinc-100 flex items-center gap-4">
            <div class="text-right">
                <p class="text-xs text-zinc-400 font-medium">CITY AVERAGE</p>
                <p id="avg-surge-val" class="text-2xl font-bold text-zinc-900">--</p>
            </div>
            <div id="surge-level-badge" class="px-3 py-1 rounded-full text-sm font-bold">--</div>
        </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 relative">
            <div class="glass-panel rounded-2xl overflow-hidden premium-shadow aspect-video md:aspect-[16/9]" id="surge-map" style="z-index: 1;"></div>
            <div class="absolute bottom-4 left-4 z-[10] flex flex-col gap-2">
                <div class="bg-white/90 backdrop-blur p-3 rounded-xl shadow-lg border border-zinc-200/50 text-xs flex flex-col gap-2">
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-[#ef4444]"></span> High Surge (>2.0x)</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-[#f59e0b]"></span> Medium Surge (1.5x-2.0x)</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-[#22c55e]"></span> Normal (1.0x-1.4x)</div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="glass-panel rounded-2xl p-6 premium-shadow">
                <h3 class="text-lg font-bold text-zinc-900 mb-4">Highest Surge Areas</h3>
                <div id="surge-list" class="space-y-3">
                    <div class="skeleton h-12 rounded-lg"></div>
                    <div class="skeleton h-12 rounded-lg"></div>
                    <div class="skeleton h-12 rounded-lg"></div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-6 premium-shadow bg-gradient-to-br from-zinc-900 to-zinc-800 text-white">
                <h3 class="text-lg font-bold mb-2">Live Insights</h3>
                <p id="surge-insight" class="text-zinc-400 text-sm mb-4">Analyzing current patterns...</p>
                <div class="p-3 bg-white/10 rounded-xl border border-white/10">
                    <p class="text-xs text-zinc-300">Strategy Tip:</p>
                    <p id="strategy-tip" class="text-sm font-medium mt-1">Wait for data...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #surge-map { height: 500px; width: 100%; }
    .surge-zone-marker {
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 800;
        font-size: 12px;
        transition: all 0.3s ease;
    }
    .surge-zone-marker:hover { transform: scale(1.1); z-index: 1000; }
    .skeleton { background: linear-gradient(90deg, #f4f4f5 25%, #e4e4e7 50%, #f4f4f5 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite; }
    @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
</style>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let surgeMap;
let markers = [];

async function loadSurgeMap() {
    try {
        const response = await fetch('/api/surge-map');
        const data = await response.json();
        
        if (data.success) {
            updateSurgeUI(data);
        }
    } catch (e) { console.error('Error loading surge:', e); }
}

function updateSurgeUI(data) {
    const { zones, overall } = data;
    
    // Update stats
    document.getElementById('avg-surge-val').textContent = overall.avgSurge.toFixed(1) + 'x';
    const badge = document.getElementById('surge-level-badge');
    badge.textContent = overall.level.toUpperCase();
    badge.className = `px-3 py-1 rounded-full text-sm font-bold ${
        overall.level === 'high' ? 'bg-red-100 text-red-600' : 
        (overall.level === 'medium' ? 'bg-amber-100 text-amber-600' : 'bg-green-100 text-green-600')
    }`;
    
    document.getElementById('surge-insight').textContent = `Peak demand detected in ${overall.peakAreas.join(', ')}.`;
    document.getElementById('strategy-tip').textContent = overall.avgSurge > 1.5 ? "High surge active. Focus on peak zones." : "Market is stable. Use Smart Route for optimal positioning.";

    // Update List
    const listEl = document.getElementById('surge-list');
    listEl.innerHTML = zones.slice(0, 5).map(z => `
        <div class="flex items-center justify-between p-3 bg-zinc-50 rounded-xl border border-zinc-100">
            <div>
                <p class="font-bold text-zinc-900 text-sm">${z.name}</p>
                <p class="text-[10px] text-zinc-500 uppercase font-bold">${z.type}</p>
            </div>
            <span class="px-2 py-1 rounded-lg text-xs font-black bg-white shadow-sm border border-zinc-100" style="color:${z.color}">${z.surge}x</span>
        </div>
    `).join('');

    // Update Markers
    markers.forEach(m => surgeMap.removeLayer(m));
    markers = [];
    
    zones.forEach(z => {
        const size = 30 + (z.surge * 5);
        const icon = L.divIcon({
            className: '',
            html: `<div class="surge-zone-marker" style="width:${size}px;height:${size}px;background:${z.color};">${z.surge}x</div>`,
            iconSize: [size, size]
        });
        const marker = L.marker([z.lat, z.lng], { icon }).addTo(surgeMap);
        marker.bindPopup(`<b>${z.name}</b><br>Predicted Surge: ${z.surge}x<br><span style="color:${z.color}">${z.level.toUpperCase()} DEMAND</span>`);
        markers.push(marker);
    });
}

document.addEventListener('DOMContentLoaded', () => {
    surgeMap = L.map('surge-map').setView([-31.9505, 115.8605], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(surgeMap);
    
    loadSurgeMap();
    setInterval(loadSurgeMap, 60000);
});
</script>
{% endblock %}
