{% extends "base.html" %}

{% block title %}RizTar | Connect Uber{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 py-8">
    <div class="mb-5">
        <a href="{{ url_for('root') }}" class="text-xs text-zinc-400 hover:text-zinc-600 flex items-center mb-2">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Back
        </a>
        <h1 class="text-xl font-bold text-zinc-900">Connect Uber Driver Account</h1>
        <p class="text-sm text-zinc-500">Link your Uber driver account to access all features</p>
    </div>

    {% if current_user.uber_connected %}
    <div class="glass-panel rounded-xl p-6 premium-shadow mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-zinc-100 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-5 h-5 text-zinc-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div>
                    <p class="text-sm font-medium text-zinc-900">Uber Account Connected</p>
                    <p class="text-xs text-zinc-500">Your driver account is linked</p>
                </div>
            </div>
            <form action="{{ url_for('uber_disconnect') }}" method="POST">
                {{ disconnect_form.hidden_tag() }}
                <button type="submit" class="px-3 py-1.5 text-xs font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                    Disconnect
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Method Tabs -->
    <div class="flex border-b border-zinc-200 mb-0">
        <button onclick="showTab('har')" id="tab-har" class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-black text-zinc-900">
            Easy Method (HAR File)
        </button>
        <button onclick="showTab('manual')" id="tab-manual" class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent text-zinc-500 hover:text-zinc-700">
            Manual Entry
        </button>
    </div>

    <!-- HAR Upload Method -->
    <div id="panel-har" class="glass-panel rounded-t-none rounded-xl premium-shadow overflow-hidden">
        <div class="p-6 border-b border-zinc-100">
            <h2 class="text-sm font-semibold text-zinc-900 mb-4">Capture Credentials From Your Phone</h2>
            
            <div class="space-y-4">
                <div class="flex items-start">
                    <div class="w-7 h-7 bg-black text-white rounded-full flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">1</div>
                    <div>
                        <p class="text-sm font-medium text-zinc-900">Install HTTP Toolkit App</p>
                        <p class="text-xs text-zinc-500">Download from <a href="https://play.google.com/store/apps/details?id=tech.httptoolkit.android" target="_blank" class="text-blue-500 hover:underline">Google Play Store</a> (Android) or <a href="https://apps.apple.com/app/http-toolkit/id1552419553" target="_blank" class="text-blue-500 hover:underline">App Store</a> (iPhone)</p>
                    </div>
                </div>
                
                <div class="flex items-start">
                    <div class="w-7 h-7 bg-black text-white rounded-full flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">2</div>
                    <div>
                        <p class="text-sm font-medium text-zinc-900">Enable VPN in HTTP Toolkit</p>
                        <p class="text-xs text-zinc-500">Open HTTP Toolkit and tap "Enable" to start capturing traffic</p>
                    </div>
                </div>
                
                <div class="flex items-start">
                    <div class="w-7 h-7 bg-black text-white rounded-full flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">3</div>
                    <div>
                        <p class="text-sm font-medium text-zinc-900">Open Uber Driver App</p>
                        <p class="text-xs text-zinc-500">Use the Uber Driver app normally - HTTP Toolkit will capture all requests</p>
                    </div>
                </div>
                
                <div class="flex items-start">
                    <div class="w-7 h-7 bg-black text-white rounded-full flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">4</div>
                    <div>
                        <p class="text-sm font-medium text-zinc-900">Find Request to uber.com</p>
                        <p class="text-xs text-zinc-500">In HTTP Toolkit, look for requests to cn-geo1.uber.com or api.uber.com</p>
                    </div>
                </div>
                
                <div class="flex items-start">
                    <div class="w-7 h-7 bg-black text-white rounded-full flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">5</div>
                    <div>
                        <p class="text-sm font-medium text-zinc-900">Export HAR File</p>
                        <p class="text-xs text-zinc-500">Tap the menu (3 dots) → "Export" → "Save as HAR"</p>
                    </div>
                </div>
                
                <div class="flex items-start">
                    <div class="w-7 h-7 bg-black text-white rounded-full flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">6</div>
                    <div>
                        <p class="text-sm font-medium text-zinc-900">Upload Below</p>
                        <p class="text-xs text-zinc-500">Upload the .har file and we'll extract everything automatically</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-6">
            <div id="dropZone" class="border-2 border-dashed border-zinc-300 rounded-xl p-8 text-center hover:border-zinc-400 transition-colors cursor-pointer"
                 ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="document.getElementById('harFile').click()">
                <input type="file" id="harFile" accept=".har" class="hidden" onchange="handleFileSelect(event)">
                <svg class="w-10 h-10 mx-auto text-zinc-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                <p class="text-sm font-medium text-zinc-700">Drop your HAR file here</p>
                <p class="text-xs text-zinc-500 mt-1">or click to browse</p>
            </div>
            
            <div id="harStatus" class="hidden mt-4 p-4 rounded-xl"></div>
            
            <div id="harResults" class="hidden mt-4 space-y-3">
                <div class="p-3 bg-zinc-100 border border-zinc-300 rounded-xl">
                    <p class="text-xs font-medium text-zinc-800">Credentials Found!</p>
                    <p class="text-xs text-zinc-600 mt-1" id="harResultsInfo"></p>
                </div>
                <form action="{{ url_for('uber_connect') }}" method="POST" id="harForm">
                    {{ form.hidden_tag() }}
                    <input type="hidden" name="headers" id="harHeaders">
                    <input type="hidden" name="cookies" id="harCookies">
                    <input type="hidden" name="refresh_token" id="harRefreshToken">
                    <button type="submit" class="w-full bg-black text-white py-3 rounded-xl font-medium text-sm hover:bg-zinc-800 transition-colors">
                        Save & Connect
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Manual Entry Method -->
    <div id="panel-manual" class="hidden glass-panel rounded-t-none rounded-xl premium-shadow overflow-hidden">
        <div class="p-6 border-b border-zinc-100">
            <h2 class="text-sm font-semibold text-zinc-900 mb-2">Manual Credential Entry</h2>
            <p class="text-xs text-zinc-500">For advanced users who prefer to enter credentials directly</p>
        </div>

        <div class="p-6">
            <form action="{{ url_for('uber_connect') }}" method="POST" class="space-y-4" id="connectForm">
                {{ form.hidden_tag() }}
                
                <div>
                    <div class="flex items-center justify-between mb-1.5">
                        <label class="text-xs font-medium text-zinc-700">Headers (JSON)</label>
                        <button type="button" onclick="parseRawHeaders()" class="text-[10px] text-blue-500 hover:text-blue-600">Parse Raw</button>
                    </div>
                    <textarea name="headers" id="headersInput" rows="5" 
                        placeholder='{"authorization": "Bearer eyJ...", "x-uber-device-id": "..."}'
                        class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-xs font-mono focus:outline-none focus:border-zinc-400 focus:ring-1 focus:ring-zinc-400"></textarea>
                </div>

                <div>
                    <div class="flex items-center justify-between mb-1.5">
                        <label class="text-xs font-medium text-zinc-700">Cookies (JSON)</label>
                        <button type="button" onclick="parseRawCookies()" class="text-[10px] text-blue-500 hover:text-blue-600">Parse Raw</button>
                    </div>
                    <textarea name="cookies" id="cookiesInput" rows="4" 
                        placeholder='{"sid": "abc123", "udi-id": "xyz789"}'
                        class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-xs font-mono focus:outline-none focus:border-zinc-400 focus:ring-1 focus:ring-zinc-400"></textarea>
                </div>

                <div>
                    <label class="block text-xs font-medium text-zinc-700 mb-1.5">Refresh Token</label>
                    <input type="text" name="refresh_token" id="refreshTokenInput" placeholder="MA.CAE..."
                        class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-xs font-mono focus:outline-none focus:border-zinc-400 focus:ring-1 focus:ring-zinc-400">
                </div>

                <div id="statusMessage" class="hidden p-3 rounded-xl text-xs"></div>

                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="testCredentials()" class="flex-1 bg-zinc-100 text-zinc-700 py-3 rounded-xl font-medium text-sm hover:bg-zinc-200 transition-colors">
                        Test Connection
                    </button>
                    <button type="submit" class="flex-1 bg-black text-white py-3 rounded-xl font-medium text-sm hover:bg-zinc-800 transition-colors">
                        Save & Connect
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function showTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-black', 'text-zinc-900');
        btn.classList.add('border-transparent', 'text-zinc-500');
    });
    document.getElementById('tab-' + tab).classList.remove('border-transparent', 'text-zinc-500');
    document.getElementById('tab-' + tab).classList.add('border-black', 'text-zinc-900');
    
    document.getElementById('panel-har').classList.toggle('hidden', tab !== 'har');
    document.getElementById('panel-manual').classList.toggle('hidden', tab !== 'manual');
}

function handleDragOver(e) {
    e.preventDefault();
    document.getElementById('dropZone').classList.add('border-black', 'bg-zinc-50');
}

function handleDragLeave(e) {
    e.preventDefault();
    document.getElementById('dropZone').classList.remove('border-black', 'bg-zinc-50');
}

function handleDrop(e) {
    e.preventDefault();
    document.getElementById('dropZone').classList.remove('border-black', 'bg-zinc-50');
    const file = e.dataTransfer.files[0];
    if (file && file.name.endsWith('.har')) {
        processHarFile(file);
    } else {
        showHarStatus('Please upload a .har file', 'error');
    }
}

function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) {
        processHarFile(file);
    }
}

function processHarFile(file) {
    showHarStatus('Processing HAR file...', 'info');
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const har = JSON.parse(e.target.result);
            const credentials = extractCredentials(har);
            
            if (credentials.headers && Object.keys(credentials.headers).length > 0) {
                document.getElementById('harHeaders').value = JSON.stringify(credentials.headers);
                document.getElementById('harCookies').value = JSON.stringify(credentials.cookies);
                document.getElementById('harRefreshToken').value = credentials.refreshToken || '';
                
                let info = `Found ${Object.keys(credentials.headers).length} headers, ${Object.keys(credentials.cookies).length} cookies`;
                if (credentials.refreshToken) info += ', refresh token';
                document.getElementById('harResultsInfo').textContent = info;
                
                document.getElementById('harResults').classList.remove('hidden');
                document.getElementById('harStatus').classList.add('hidden');
            } else {
                showHarStatus('No Uber credentials found in HAR file. Make sure you logged into drivers.uber.com before exporting.', 'error');
            }
        } catch (err) {
            showHarStatus('Error parsing HAR file: ' + err.message, 'error');
        }
    };
    reader.readAsText(file);
}

function extractCredentials(har) {
    const result = { headers: {}, cookies: {}, refreshToken: null };
    const entries = har.log?.entries || [];
    
    const importantHeaders = ['authorization', 'x-uber-device-id', 'x-uber-device', 'x-csrf-token', 'user-agent', 'x-uber-client-name'];
    
    for (const entry of entries) {
        const url = entry.request?.url || '';
        
        if (url.includes('uber.com')) {
            const headers = entry.request?.headers || [];
            for (const h of headers) {
                const name = h.name.toLowerCase();
                if (importantHeaders.includes(name) || name.startsWith('x-uber')) {
                    result.headers[name] = h.value;
                }
            }
            
            const cookieHeader = headers.find(h => h.name.toLowerCase() === 'cookie');
            if (cookieHeader) {
                const parts = cookieHeader.value.split(';');
                for (const part of parts) {
                    const eqIdx = part.indexOf('=');
                    if (eqIdx > 0) {
                        const key = part.substring(0, eqIdx).trim();
                        const val = part.substring(eqIdx + 1).trim();
                        result.cookies[key] = val;
                    }
                }
            }
            
            const responseText = entry.response?.content?.text || '';
            const tokenMatch = responseText.match(/"refresh_token"\s*:\s*"(MA\.[^"]+)"/);
            if (tokenMatch) {
                result.refreshToken = tokenMatch[1];
            }
        }
    }
    
    return result;
}

function showHarStatus(message, type) {
    const el = document.getElementById('harStatus');
    el.textContent = message;
    el.className = 'mt-4 p-4 rounded-xl text-xs ' + 
        (type === 'error' ? 'bg-red-50 text-red-700 border border-red-200' : 
         type === 'info' ? 'bg-blue-50 text-blue-700 border border-blue-200' : 
         'bg-zinc-100 text-zinc-700 border border-zinc-300');
    el.classList.remove('hidden');
    document.getElementById('harResults').classList.add('hidden');
}

function parseRawHeaders() {
    const input = document.getElementById('headersInput');
    const value = input.value.trim();
    if (!value) return;
    try { JSON.parse(value); return; } catch (e) {}
    
    const headers = {};
    const lines = value.split('\n');
    for (const line of lines) {
        const colonIndex = line.indexOf(':');
        if (colonIndex > 0) {
            const key = line.substring(0, colonIndex).trim().toLowerCase();
            const val = line.substring(colonIndex + 1).trim();
            if (key && val) headers[key] = val;
        }
    }
    if (Object.keys(headers).length > 0) {
        input.value = JSON.stringify(headers, null, 2);
        showStatus('Headers parsed!', 'success');
    }
}

function parseRawCookies() {
    const input = document.getElementById('cookiesInput');
    const value = input.value.trim();
    if (!value) return;
    try { JSON.parse(value); return; } catch (e) {}
    
    const cookies = {};
    const parts = value.split(';');
    for (const part of parts) {
        const eqIndex = part.indexOf('=');
        if (eqIndex > 0) {
            const key = part.substring(0, eqIndex).trim();
            const val = part.substring(eqIndex + 1).trim();
            if (key) cookies[key] = val;
        }
    }
    if (Object.keys(cookies).length > 0) {
        input.value = JSON.stringify(cookies, null, 2);
        showStatus('Cookies parsed!', 'success');
    }
}

function showStatus(message, type) {
    const el = document.getElementById('statusMessage');
    el.textContent = message;
    el.className = 'p-3 rounded-xl text-xs ' + (type === 'success' ? 'bg-zinc-100 text-zinc-700 border border-zinc-300' : 'bg-red-50 text-red-700 border border-red-200');
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 3000);
}

async function testCredentials() {
    const headers = document.getElementById('headersInput').value.trim();
    const cookies = document.getElementById('cookiesInput').value.trim();
    const refreshToken = document.getElementById('refreshTokenInput').value.trim();
    
    if (!headers || !cookies || !refreshToken) {
        showStatus('Please fill in all fields.', 'error');
        return;
    }
    
    try { JSON.parse(headers); JSON.parse(cookies); } catch (e) {
        showStatus('Invalid JSON. Click "Parse Raw" to convert.', 'error');
        return;
    }
    
    showStatus('Testing...', 'success');
    
    try {
        const response = await fetch('/api/test-uber-credentials', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ headers, cookies, refresh_token: refreshToken })
        });
        const data = await response.json();
        showStatus(data.success ? 'Connection successful!' : 'Failed: ' + data.error, data.success ? 'success' : 'error');
    } catch (e) {
        showStatus('Error: ' + e.message, 'error');
    }
}
</script>
{% endblock %}
