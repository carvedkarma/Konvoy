{% extends "base.html" %}

{% block title %}Konvoy | Connect Uber{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 py-8">
    <div class="mb-5">
        <a href="{{ url_for('root') }}" class="text-xs text-zinc-400 hover:text-zinc-600 flex items-center mb-2">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Back
        </a>
        <h1 class="text-xl font-bold text-zinc-900">Connect Uber Driver Account</h1>
        <p class="text-sm text-zinc-500">Link your Uber driver account to access all features</p>
    </div>

    {% if current_user.uber_connected %}
    <div class="glass-panel rounded-xl p-6 premium-shadow mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div>
                    <p class="text-sm font-medium text-zinc-900">Uber Account Connected</p>
                    <p class="text-xs text-zinc-500">Your driver account is linked</p>
                </div>
            </div>
            <form action="{{ url_for('uber_disconnect') }}" method="POST">
                {{ disconnect_form.hidden_tag() }}
                <button type="submit" class="px-3 py-1.5 text-xs font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                    Disconnect
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="glass-panel rounded-xl premium-shadow overflow-hidden">
        <!-- Connection Method Selection -->
        <div class="p-6 border-b border-zinc-100">
            <h2 class="text-sm font-semibold text-zinc-900 mb-3">Choose Connection Method</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <button onclick="showMethod('bookmarklet')" id="btn-bookmarklet" class="method-btn active p-4 rounded-xl border-2 border-black bg-zinc-50 text-left transition-all">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-zinc-700 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                        </svg>
                        <span class="text-sm font-medium text-zinc-900">Bookmarklet</span>
                    </div>
                    <p class="text-xs text-zinc-500">One-click capture</p>
                </button>
                <button onclick="showMethod('popup')" id="btn-popup" class="method-btn p-4 rounded-xl border-2 border-zinc-200 hover:border-zinc-300 text-left transition-all">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-zinc-700 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                        <span class="text-sm font-medium text-zinc-900">Guided</span>
                    </div>
                    <p class="text-xs text-zinc-500">Step-by-step</p>
                </button>
                <button onclick="showMethod('manual')" id="btn-manual" class="method-btn p-4 rounded-xl border-2 border-zinc-200 hover:border-zinc-300 text-left transition-all">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-zinc-700 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                        </svg>
                        <span class="text-sm font-medium text-zinc-900">Manual</span>
                    </div>
                    <p class="text-xs text-zinc-500">Paste directly</p>
                </button>
            </div>
        </div>

        <!-- Bookmarklet Method (Recommended) -->
        <div id="method-bookmarklet" class="p-6">
            <div class="mb-6">
                <div class="flex items-center mb-4">
                    <span class="px-2 py-0.5 bg-green-100 text-green-700 text-[10px] font-bold rounded-full mr-2">EASIEST</span>
                    <h3 class="text-sm font-semibold text-zinc-900">Bookmarklet Capture</h3>
                </div>
                
                <div class="space-y-4">
                    <div class="flex items-start">
                        <div class="w-6 h-6 bg-black text-white rounded-full flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">1</div>
                        <div class="flex-1">
                            <p class="text-sm text-zinc-600 mb-2">Drag this button to your bookmarks bar:</p>
                            <a href="javascript:(function(){var c=document.cookie;var cs={};c.split(';').forEach(function(x){var p=x.trim().split('=');if(p[0])cs[p[0]]=p[1]||'';});var d=JSON.stringify(cs);var w=window.open('{{ callback_url }}?cookies='+encodeURIComponent(d),'_blank');})();" 
                               class="inline-flex items-center px-4 py-2 bg-black text-white text-sm font-medium rounded-lg hover:bg-zinc-800 cursor-grab active:cursor-grabbing"
                               onclick="event.preventDefault();alert('Drag this button to your bookmarks bar!');">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                                </svg>
                                Capture Uber
                            </a>
                            <p class="text-xs text-zinc-400 mt-2">Can't drag? Right-click and "Bookmark This Link"</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <div class="w-6 h-6 bg-black text-white rounded-full flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">2</div>
                        <div class="flex-1">
                            <p class="text-sm text-zinc-600 mb-2">Go to Uber's driver portal and log in:</p>
                            <a href="https://drivers.uber.com/" target="_blank" 
                               class="inline-flex items-center px-4 py-2 bg-zinc-100 text-zinc-700 text-sm font-medium rounded-lg hover:bg-zinc-200">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                </svg>
                                Open Uber Driver Portal
                            </a>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <div class="w-6 h-6 bg-black text-white rounded-full flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">3</div>
                        <p class="text-sm text-zinc-600">After logging in, click the "Capture Uber" bookmark - it will grab your cookies automatically!</p>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-amber-50 border border-amber-200 rounded-xl">
                <p class="text-xs text-amber-700">
                    <strong>Note:</strong> The bookmarklet captures cookies from Uber's web portal. For full driver API access (location updates, vehicle info), 
                    you'll also need to provide headers and refresh token from the Uber Driver mobile app using the Manual method.
                </p>
            </div>
        </div>

        <!-- Popup Method -->
        <div id="method-popup" class="p-6 hidden">
            <div class="mb-6">
                <h3 class="text-sm font-semibold text-zinc-900 mb-2">Guided Setup</h3>
                <div class="space-y-3">
                    <div class="flex items-start">
                        <div class="w-6 h-6 bg-black text-white rounded-full flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">1</div>
                        <p class="text-sm text-zinc-600">Click the button below to open Uber's driver portal</p>
                    </div>
                    <div class="flex items-start">
                        <div class="w-6 h-6 bg-black text-white rounded-full flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">2</div>
                        <p class="text-sm text-zinc-600">Log in with your Uber driver account</p>
                    </div>
                    <div class="flex items-start">
                        <div class="w-6 h-6 bg-black text-white rounded-full flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">3</div>
                        <p class="text-sm text-zinc-600">Use Developer Tools (F12) to capture cookies & headers</p>
                    </div>
                </div>
            </div>

            <button onclick="openUberLogin()" class="w-full bg-black text-white py-3 rounded-xl font-medium text-sm hover:bg-zinc-800 transition-colors flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
                Open Uber Login
            </button>
        </div>

        <!-- Manual Entry Method -->
        <div id="method-manual" class="p-6 hidden">
            <div class="mb-6 p-4 bg-zinc-50 border border-zinc-200 rounded-xl">
                <h4 class="text-xs font-semibold text-zinc-700 mb-2">How to Get Credentials</h4>
                <ol class="text-xs text-zinc-600 space-y-1 list-decimal list-inside">
                    <li>Open the Uber Driver app on your phone</li>
                    <li>Use a proxy tool (Charles, mitmproxy, HTTP Toolkit) to capture traffic</li>
                    <li>Find any request to <code class="bg-zinc-200 px-1 rounded">cn-geo1.uber.com</code></li>
                    <li>Copy the cookies, headers, and find the refresh token</li>
                </ol>
            </div>

            <form action="{{ url_for('uber_connect') }}" method="POST" class="space-y-4">
                {{ form.hidden_tag() }}
                <div>
                    <label class="block text-xs font-medium text-zinc-700 mb-1.5">Cookies (JSON format)</label>
                    <textarea name="cookies" rows="3" placeholder='{"sid": "...", "udi-id": "..."}'
                        class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-xs font-mono focus:outline-none focus:border-zinc-400 focus:ring-1 focus:ring-zinc-400"></textarea>
                </div>

                <div>
                    <label class="block text-xs font-medium text-zinc-700 mb-1.5">Headers (JSON format)</label>
                    <textarea name="headers" rows="5" placeholder='{"authorization": "Bearer ...", "x-uber-device-id": "..."}'
                        class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-xs font-mono focus:outline-none focus:border-zinc-400 focus:ring-1 focus:ring-zinc-400"></textarea>
                </div>

                <div>
                    <label class="block text-xs font-medium text-zinc-700 mb-1.5">Refresh Token</label>
                    <input type="text" name="refresh_token" placeholder="MA.CAE..."
                        class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-xs font-mono focus:outline-none focus:border-zinc-400 focus:ring-1 focus:ring-zinc-400">
                </div>

                <button type="submit" class="w-full bg-black text-white py-3 rounded-xl font-medium text-sm hover:bg-zinc-800 transition-colors">
                    Connect Account
                </button>
            </form>
        </div>
    </div>
</div>

<style>
.method-btn.active {
    border-color: #000;
    background-color: rgb(250 250 250);
}
.method-btn:not(.active) {
    border-color: rgb(228 228 231);
}
</style>

<script>
function showMethod(method) {
    document.getElementById('method-bookmarklet').classList.add('hidden');
    document.getElementById('method-popup').classList.add('hidden');
    document.getElementById('method-manual').classList.add('hidden');
    document.getElementById('method-' + method).classList.remove('hidden');
    
    document.querySelectorAll('.method-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('border-black');
        btn.classList.add('border-zinc-200');
    });
    document.getElementById('btn-' + method).classList.add('active');
    document.getElementById('btn-' + method).classList.add('border-black');
    document.getElementById('btn-' + method).classList.remove('border-zinc-200');
}

function openUberLogin() {
    const width = 500;
    const height = 700;
    const left = (screen.width - width) / 2;
    const top = (screen.height - height) / 2;
    
    window.open(
        'https://drivers.uber.com/',
        'UberLogin',
        `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`
    );
}
</script>
{% endblock %}
