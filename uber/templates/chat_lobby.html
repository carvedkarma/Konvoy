{% extends "base.html" %}

{% block title %}RizTar | Chat Lobby{% endblock %}

{% block extra_styles %}
<style>
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
@keyframes pulse-online {
    0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
    50% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
}
.message-enter {
    animation: fadeIn 0.2s ease-out;
}
@media (max-width: 640px) {
    .message-enter {
        animation: none;
    }
}
.online-pulse {
    animation: pulse-online 2s infinite;
}
.user-chip {
    transition: all 0.15s ease;
}
@media (hover: hover) {
    .user-chip:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
}
.chat-wrapper {
    height: calc(100svh - 140px);
    min-height: 300px;
    display: flex;
    flex-direction: column;
}
.chat-container {
    flex: 1;
    min-height: 0;
    background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(250,250,250,0.9));
    border: 1px solid rgba(0,0,0,0.06);
    display: flex;
    flex-direction: column;
}
.messages-area {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
}
.messages-area::-webkit-scrollbar {
    width: 5px;
}
.messages-area::-webkit-scrollbar-track {
    background: transparent;
}
.messages-area::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, #a1a1aa, #71717a);
    border-radius: 10px;
}
.mention-highlight {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(147, 51, 234, 0.12));
    border-left: 3px solid #3b82f6;
}
.online-panel {
    background: linear-gradient(135deg, rgba(24,24,27,0.03), rgba(63,63,70,0.05));
    border: 1px solid rgba(0,0,0,0.04);
    flex-shrink: 0;
}
.online-label {
    background: linear-gradient(90deg, #18181b, #3f3f46);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.user-card-popup {
    animation: fadeIn 0.15s ease-out;
    backdrop-filter: blur(12px);
    max-width: calc(100vw - 32px);
}
.user-card-popup::before {
    content: '';
    position: absolute;
    top: -6px;
    left: 20px;
    width: 12px;
    height: 12px;
    background: white;
    transform: rotate(45deg);
    border-left: 1px solid rgba(0,0,0,0.08);
    border-top: 1px solid rgba(0,0,0,0.08);
}
.input-area {
    flex-shrink: 0;
}
@media (max-width: 640px) {
    .chat-wrapper {
        height: calc(100svh - 120px);
    }
    .header-section {
        padding: 0.75rem 1rem;
    }
    .header-section h1 {
        font-size: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div id="user-card" class="user-card-popup hidden fixed z-50 bg-white rounded-xl shadow-xl border border-zinc-100 p-4 min-w-[200px]">
    <div class="flex items-center mb-3">
        <div id="card-avatar" class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3"></div>
        <div>
            <div id="card-name" class="font-semibold text-zinc-900 text-sm"></div>
            <div id="card-username" class="text-xs text-zinc-500"></div>
        </div>
    </div>
    <div id="card-roles" class="flex flex-wrap gap-1 mb-2"></div>
    <div id="card-status" class="flex items-center text-xs text-zinc-500">
        <div class="w-2 h-2 bg-green-500 rounded-full mr-1.5"></div>
        <span>Online</span>
    </div>
</div>

<div class="px-3 sm:px-4 py-3 sm:py-4">
    <div class="max-w-6xl mx-auto chat-wrapper">
        
        <div class="header-section flex items-center justify-between mb-3 sm:mb-4 flex-shrink-0">
            <div class="flex items-center min-w-0">
                <a href="{{ url_for('root') }}" class="mr-3 p-2 rounded-lg bg-zinc-100 hover:bg-zinc-200 transition-colors flex-shrink-0">
                    <svg class="w-5 h-5 text-zinc-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </a>
                <div class="min-w-0">
                    <h1 class="text-lg sm:text-xl font-bold text-zinc-900 truncate">Chat Lobby</h1>
                    <p class="text-xs text-zinc-500 hidden sm:block">Real-time team communication</p>
                </div>
            </div>
            <div class="flex items-center space-x-2 flex-shrink-0">
                <div class="w-2 h-2 bg-green-500 rounded-full online-pulse"></div>
                <span id="online-count" class="text-xs sm:text-sm text-zinc-600">0 online</span>
            </div>
        </div>

        <div class="chat-container rounded-2xl premium-shadow flex flex-col overflow-hidden">
            
            <div id="messages" class="messages-area p-2 sm:p-3 space-y-1">
                <div class="flex items-center justify-center py-8">
                    <div class="text-center">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-zinc-100 flex items-center justify-center">
                            <svg class="w-6 h-6 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                        </div>
                        <p class="text-sm text-zinc-500">Loading messages...</p>
                    </div>
                </div>
            </div>

            <div class="input-area p-3 sm:p-4 border-t border-zinc-100 bg-white">
                <form id="message-form" class="flex items-center gap-2 sm:gap-3">
                    <div class="flex-1 relative">
                        <input type="text" id="message-input" placeholder="Type a message..." 
                            class="w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-zinc-400 focus:ring-2 focus:ring-zinc-100 transition-all"
                            autocomplete="off" enterkeyhint="send">
                        <div id="mention-dropdown" class="hidden absolute bottom-full left-0 right-0 mb-1 bg-white border border-zinc-200 rounded-lg shadow-lg max-h-32 overflow-y-auto z-10">
                        </div>
                    </div>
                    <button type="submit" class="p-2.5 sm:px-4 sm:py-3 bg-black text-white rounded-xl font-medium text-sm hover:bg-zinc-800 transition-colors flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 sm:w-4 sm:h-4 sm:mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                        </svg>
                        <span class="hidden sm:inline">Send</span>
                    </button>
                </form>
            </div>
        </div>

        <div id="online-users" class="mt-2 sm:mt-4 p-2 sm:p-3 rounded-xl online-panel">
            <div class="flex items-center mb-1.5 sm:mb-2">
                <div class="w-2 h-2 bg-green-500 rounded-full online-pulse mr-2"></div>
                <span class="text-[10px] sm:text-xs font-semibold online-label">Online Now</span>
            </div>
            <div id="online-users-list" class="flex flex-wrap gap-1 sm:gap-1.5">
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.0/socket.io.min.js"></script>
<script>
const socket = io({
    transports: ['polling', 'websocket'],
    reconnectionDelay: 500,
    reconnectionDelayMax: 3000,
    timeout: 10000
});
const currentUserId = {{ current_user.id|tojson }};
const currentUsername = {{ current_user.username|tojson }};
let allUsers = [];

const roleColors = {
    'yellow': ['from-amber-400', 'to-yellow-500'],
    'blue': ['from-blue-400', 'to-blue-600'],
    'gray': ['from-zinc-400', 'to-zinc-500'],
    'red': ['from-red-400', 'to-red-600'],
    'green': ['from-emerald-400', 'to-green-600'],
    'purple': ['from-purple-400', 'to-purple-600'],
    'pink': ['from-pink-400', 'to-pink-600'],
    'orange': ['from-orange-400', 'to-orange-600']
};

function getRoleGradient(roles) {
    if (!roles || roles.length === 0) return 'from-zinc-400 to-zinc-500';
    if (roles.length === 1) {
        const color = roles[0].color || 'gray';
        const colors = roleColors[color] || roleColors['gray'];
        return `${colors[0]} ${colors[1]}`;
    }
    const firstColor = roleColors[roles[0].color] || roleColors['gray'];
    const lastColor = roleColors[roles[roles.length - 1].color] || roleColors['gray'];
    return `${firstColor[0]} ${lastColor[1]}`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTime(isoString) {
    const date = new Date(isoString);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function getPageLabel(page) {
    const pageMap = {
        '/': 'Home',
        '/change-location': 'Location',
        '/fetch-ride': 'Rides',
        '/chat-lobby': 'Chat',
        '/profile': 'Profile',
        '/admin': 'Admin',
        '/roles': 'Roles',
        '/uber-connect': 'Uber',
        '/flight-center': 'Flights'
    };
    return pageMap[page] || 'Browsing';
}

function renderOnlineUsers(users) {
    const container = document.getElementById('online-users-list');
    const countEl = document.getElementById('online-count');
    countEl.textContent = `${users.length} online`;
    
    let html = '';
    
    users.forEach(user => {
        const gradient = getRoleGradient(user.roles);
        const pageLabel = getPageLabel(user.current_page);
        const avatarHtml = user.profile_image 
            ? `<img src="${escapeHtml(user.profile_image)}" class="w-5 h-5 rounded-full object-cover">`
            : `<div class="w-5 h-5 rounded-full bg-white/30 flex items-center justify-center text-white text-[9px] font-bold">
                    ${escapeHtml(user.initials)}
                </div>`;
        html += `
            <div class="user-chip flex items-center px-2 py-1 rounded-full bg-gradient-to-r ${gradient} cursor-pointer shadow-sm"
                 onclick="mentionUser('${escapeHtml(user.username)}')" title="${escapeHtml(user.display_name)} - ${pageLabel}">
                ${avatarHtml}
                <span class="text-white text-[10px] font-medium ml-1.5 max-w-[60px] truncate">${escapeHtml(user.display_name.split(' ')[0])}</span>
                <span class="text-white/70 text-[8px] ml-1 hidden sm:inline">${pageLabel}</span>
            </div>
        `;
    });
    
    container.innerHTML = html || '<span class="text-xs text-zinc-400">No users online</span>';
}

function renderMessage(msg, prepend = false) {
    const container = document.getElementById('messages');
    const isOwn = msg.user_id === currentUserId;
    const isMentioned = msg.mentioned_user === currentUsername;
    const gradient = getRoleGradient(msg.roles);
    
    const rolesJson = JSON.stringify(msg.roles || []).replace(/'/g, "\\'").replace(/"/g, '&quot;');
    const avatarHtml = msg.user_image
        ? `<img src="${escapeHtml(msg.user_image)}" class="w-6 h-6 rounded-full object-cover avatar-click cursor-pointer hover:ring-2 hover:ring-zinc-300 transition-all mt-0.5"
                 onclick="showUserCard(event, ${msg.user_id}, '${escapeHtml(msg.username || '')}', '${escapeHtml(msg.user_name)}', '${escapeHtml(msg.user_initials)}', JSON.parse(this.dataset.roles), '${escapeHtml(msg.user_image)}')"
                 data-roles="${rolesJson}">`
        : `<div class="avatar-click w-6 h-6 rounded-full bg-gradient-to-r ${gradient} flex items-center justify-center text-white text-[9px] font-bold flex-shrink-0 cursor-pointer hover:ring-2 hover:ring-zinc-300 transition-all mt-0.5"
                 onclick="showUserCard(event, ${msg.user_id}, '${escapeHtml(msg.username || '')}', '${escapeHtml(msg.user_name)}', '${escapeHtml(msg.user_initials)}', JSON.parse(this.dataset.roles))"
                 data-roles="${rolesJson}">
                ${escapeHtml(msg.user_initials)}
            </div>`;

    const messageHtml = `
        <div class="message-enter flex items-start gap-1.5 ${isMentioned ? 'mention-highlight rounded-lg p-1.5 -mx-1.5' : ''}" data-message-id="${msg.id}">
            ${avatarHtml}
            <div class="bg-zinc-100 text-zinc-800 px-2.5 py-1.5 rounded-xl rounded-tl-sm text-[13px] max-w-[85%]">
                ${formatMessageText(msg.message)}
            </div>
            <span class="text-[9px] text-zinc-400 flex-shrink-0 mt-1">${formatTime(msg.created_at)}</span>
        </div>
    `;
    
    if (prepend) {
        container.insertAdjacentHTML('afterbegin', messageHtml);
    } else {
        container.insertAdjacentHTML('beforeend', messageHtml);
        requestAnimationFrame(() => {
            container.scrollTop = container.scrollHeight;
        });
    }
}

function formatMessageText(text) {
    let escaped = escapeHtml(text);
    escaped = escaped.replace(/@(\w+)/g, '<span class="bg-blue-100 text-blue-700 px-1 rounded font-medium">@$1</span>');
    return escaped;
}

function mentionUser(username) {
    const input = document.getElementById('message-input');
    const currentVal = input.value;
    if (currentVal && !currentVal.endsWith(' ')) {
        input.value = currentVal + ' @' + username + ' ';
    } else {
        input.value = currentVal + '@' + username + ' ';
    }
    input.focus();
}

let userDataCache = {};

function showUserCard(event, userId, username, displayName, initials, roles, userImage) {
    event.stopPropagation();
    const card = document.getElementById('user-card');
    const avatar = document.getElementById('card-avatar');
    const nameEl = document.getElementById('card-name');
    const usernameEl = document.getElementById('card-username');
    const rolesEl = document.getElementById('card-roles');
    const statusEl = document.getElementById('card-status');
    
    const gradient = getRoleGradient(roles);
    if (userImage) {
        avatar.className = 'w-10 h-10 rounded-full object-cover mr-3';
        avatar.innerHTML = `<img src="${escapeHtml(userImage)}" class="w-full h-full rounded-full object-cover">`;
    } else {
        avatar.className = `w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3 bg-gradient-to-r ${gradient}`;
        avatar.textContent = initials;
    }
    nameEl.textContent = displayName;
    usernameEl.textContent = '@' + username;
    
    const isOnline = Object.keys(online_users_data).includes(String(userId));
    statusEl.innerHTML = isOnline 
        ? '<div class="w-2 h-2 bg-green-500 rounded-full mr-1.5"></div><span>Online</span>'
        : '<div class="w-2 h-2 bg-zinc-300 rounded-full mr-1.5"></div><span>Offline</span>';
    
    rolesEl.innerHTML = roles.map(r => {
        const colors = roleColors[r.color] || roleColors['gray'];
        return `<span class="px-2 py-0.5 rounded-full text-[10px] font-medium text-white bg-gradient-to-r ${colors[0]} ${colors[1]}">${escapeHtml(r.name)}</span>`;
    }).join('');
    
    const rect = event.target.getBoundingClientRect();
    card.style.left = `${rect.left}px`;
    card.style.top = `${rect.bottom + 8}px`;
    card.classList.remove('hidden');
}

let online_users_data = {};

document.addEventListener('click', function(e) {
    const card = document.getElementById('user-card');
    if (!card.contains(e.target) && !e.target.closest('.avatar-click')) {
        card.classList.add('hidden');
    }
});

const messageInput = document.getElementById('message-input');
let mentionTimeout;
messageInput.addEventListener('input', function() {
    clearTimeout(mentionTimeout);
    const value = this.value;
    const atMatch = value.match(/@(\w*)$/);
    
    if (atMatch) {
        mentionTimeout = setTimeout(() => {
            const query = atMatch[1].toLowerCase();
            const filtered = allUsers.filter(u => 
                u.username.toLowerCase().includes(query) || 
                u.display_name.toLowerCase().includes(query)
            ).slice(0, 5);
            
            if (filtered.length > 0) {
                const dropdown = document.getElementById('mention-dropdown');
                dropdown.innerHTML = filtered.map(u => `
                    <div class="px-3 py-2 hover:bg-zinc-100 cursor-pointer text-sm" onclick="selectMention('${u.username}')">
                        <span class="font-medium">@${escapeHtml(u.username)}</span>
                        <span class="text-zinc-500 ml-2">${escapeHtml(u.display_name)}</span>
                    </div>
                `).join('');
                dropdown.classList.remove('hidden');
            } else {
                document.getElementById('mention-dropdown').classList.add('hidden');
            }
        }, 100);
    } else {
        document.getElementById('mention-dropdown').classList.add('hidden');
    }
});

function selectMention(username) {
    const input = document.getElementById('message-input');
    input.value = input.value.replace(/@\w*$/, '@' + username + ' ');
    document.getElementById('mention-dropdown').classList.add('hidden');
    input.focus();
}

document.getElementById('message-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    const mentionMatch = message.match(/@(\w+)/);
    const mentionedUser = mentionMatch ? mentionMatch[1] : null;
    
    console.log('Sending message:', message);
    socket.emit('send_message', {
        message: message,
        mentioned_user: mentionedUser
    });
    
    input.value = '';
});

socket.on('connect', function() {
    console.log('Connected to chat, socket id:', socket.id);
    fetchActiveUsers();
});

socket.on('connect_error', function(error) {
    console.error('Socket connection error:', error);
});

socket.on('disconnect', function(reason) {
    console.log('Socket disconnected:', reason);
});

function fetchActiveUsers() {
    fetch('/api/active-users')
        .then(r => r.json())
        .then(data => {
            if (data.users) {
                console.log('Fetched active users:', data.users.length);
                online_users_data = {};
                data.users.forEach(u => { online_users_data[u.id] = u; });
                renderOnlineUsers(data.users);
            }
        })
        .catch(err => console.error('Error fetching active users:', err));
}

fetchActiveUsers();
setInterval(fetchActiveUsers, 10000);

socket.on('user_joined', function(user) {
    console.log('User joined chat:', user.display_name);
    fetchActiveUsers();
});

socket.on('user_left', function(data) {
    console.log('User left chat:', data.id);
    fetchActiveUsers();
});

socket.on('new_message', function(msg) {
    console.log('Received new message:', msg.id);
    renderMessage(msg);
});

fetch('/api/chat-messages')
    .then(r => r.json())
    .then(data => {
        const container = document.getElementById('messages');
        container.innerHTML = '';
        if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => renderMessage(msg));
        } else {
            container.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="text-center">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-zinc-100 flex items-center justify-center">
                            <svg class="w-6 h-6 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                        </div>
                        <p class="text-sm text-zinc-500">No messages yet. Start the conversation!</p>
                    </div>
                </div>
            `;
        }
    });

fetch('/api/chat-users')
    .then(r => r.json())
    .then(data => {
        if (data.users) {
            allUsers = data.users;
        }
    });

const msgInput = document.getElementById('message-input');
const messagesArea = document.getElementById('messages');

msgInput.addEventListener('focus', function() {
    setTimeout(() => {
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }, 300);
});

if ('visualViewport' in window) {
    window.visualViewport.addEventListener('resize', function() {
        messagesArea.scrollTop = messagesArea.scrollHeight;
    });
}
</script>
{% endblock %}
