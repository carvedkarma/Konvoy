{% extends "base.html" %}

{% block title %}Demand Hotspots - RizTar{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 24px;
        z-index: 1;
        border: none;
        box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2);
    }
    .leaflet-container {
        background: #f1f5f9 !important;
        font-family: 'Inter', sans-serif;
    }
    .leaflet-tile {
        filter: saturate(0.85) contrast(1.05);
    }
    .leaflet-bar {
        border: none !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
        border-radius: 12px !important;
        overflow: hidden;
    }
    .leaflet-bar a {
        background-color: rgba(255, 255, 255, 0.95) !important;
        backdrop-filter: blur(8px);
        color: #1f2937 !important;
        border: none !important;
        width: 36px !important;
        height: 36px !important;
        line-height: 36px !important;
    }
    .leaflet-bar a:hover {
        background-color: rgba(255, 255, 255, 1) !important;
    }
    .leaflet-popup-content-wrapper {
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15);
        padding: 0;
    }
    .leaflet-popup-content {
        margin: 0;
    }
    .leaflet-popup-tip {
        background: rgba(255, 255, 255, 0.95);
    }
    .hotspot-marker {
        border-radius: 50%;
        border: 3px solid rgba(255, 255, 255, 0.9);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    .demand-high { 
        background: linear-gradient(135deg, #f43f5e, #e11d48); 
        box-shadow: 0 0 20px rgba(225, 29, 72, 0.5);
    }
    .demand-medium { 
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        box-shadow: 0 0 20px rgba(245, 158, 11, 0.4);
    }
    .demand-low { 
        background: linear-gradient(135deg, #34d399, #10b981);
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
    }
    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }
    .pulse-animation {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.15); opacity: 0.85; }
        100% { transform: scale(1); opacity: 1; }
    }
    .user-location-marker {
        width: 16px;
        height: 16px;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3), 0 2px 8px rgba(0,0,0,0.3);
    }
    .search-container {
        position: relative;
    }
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    .search-results.active {
        display: block;
    }
    .search-result-item {
        padding: 10px 14px;
        cursor: pointer;
        border-bottom: 1px solid #f4f4f5;
        font-size: 13px;
    }
    .search-result-item:hover {
        background: #f4f4f5;
    }
    .search-result-item:last-child {
        border-bottom: none;
    }
    .weather-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 197, 253, 0.2));
        border-radius: 20px;
        font-size: 12px;
        color: #1e40af;
        font-weight: 500;
    }
    .hotspot-card {
        transition: all 0.2s ease;
    }
    .hotspot-card:hover {
        transform: translateX(4px);
    }
    .skeleton {
        background: linear-gradient(90deg, #f4f4f5 25%, #e4e4e7 50%, #f4f4f5 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s infinite;
    }
    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    .peak-badge {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 9px;
        font-weight: 600;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-zinc-900 mb-2">Demand Hotspots</h1>
        <p class="text-zinc-500">AI-powered predictions based on time, weather, and location patterns</p>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2">
            <div class="glass-panel rounded-2xl p-6 premium-shadow">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-lg font-bold text-zinc-900">Live Hotspot Map</h2>
                        <span id="last-updated" class="text-xs text-zinc-400"></span>
                    </div>
                    <div class="flex items-center gap-4 text-xs">
                        <div class="flex items-center gap-1.5">
                            <span class="legend-dot demand-high"></span>
                            <span class="text-zinc-600">High</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="legend-dot demand-medium"></span>
                            <span class="text-zinc-600">Medium</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="legend-dot demand-low"></span>
                            <span class="text-zinc-600">Low</span>
                        </div>
                    </div>
                </div>
                
                <div class="search-container mb-4">
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <input type="text" id="location-search" placeholder="Search for a location..." 
                            class="w-full pl-10 pr-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-zinc-400 focus:ring-4 focus:ring-zinc-100 transition-all">
                        <button id="my-location-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors" title="Go to my location">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </button>
                    </div>
                    <div id="search-results" class="search-results"></div>
                </div>
                
                <div id="map"></div>
                <p id="location-status" class="text-xs text-zinc-400 mt-2 text-center"></p>
            </div>
        </div>

        <div class="space-y-6">
            <div class="glass-panel rounded-2xl p-6 premium-shadow">
                <h3 class="text-lg font-bold text-zinc-900 mb-4">Current Conditions</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-zinc-500">Time Period</span>
                        <span id="time-period" class="text-sm font-semibold text-zinc-900">
                            <span class="skeleton h-4 w-24 inline-block rounded"></span>
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-zinc-500">Day Type</span>
                        <span id="day-type" class="text-sm font-semibold text-zinc-900">
                            <span class="skeleton h-4 w-20 inline-block rounded"></span>
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-zinc-500">Weather</span>
                        <span id="weather-info" class="text-sm font-semibold text-zinc-900">
                            <span class="skeleton h-4 w-28 inline-block rounded"></span>
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-zinc-500">Overall Demand</span>
                        <span id="overall-demand" class="px-2 py-0.5 text-xs font-bold rounded-full skeleton h-5 w-16"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-zinc-500">Flights (1hr)</span>
                        <span id="flights-info" class="text-sm font-semibold text-zinc-900">
                            <span class="skeleton h-4 w-20 inline-block rounded"></span>
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-zinc-500">Events</span>
                        <span id="events-info" class="text-sm font-semibold text-zinc-900">
                            <span class="skeleton h-4 w-20 inline-block rounded"></span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-6 premium-shadow">
                <h3 class="text-lg font-bold text-zinc-900 mb-4">Top Hotspots Now</h3>
                <div id="top-hotspots" class="space-y-3">
                    <div class="skeleton h-16 rounded-lg"></div>
                    <div class="skeleton h-16 rounded-lg"></div>
                    <div class="skeleton h-16 rounded-lg"></div>
                    <div class="skeleton h-16 rounded-lg"></div>
                    <div class="skeleton h-16 rounded-lg"></div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-6 premium-shadow">
                <h3 class="text-lg font-bold text-zinc-900 mb-4">Smart Tips</h3>
                <div id="tips" class="space-y-2 text-sm text-zinc-600">
                    <div class="skeleton h-12 rounded-lg"></div>
                    <div class="skeleton h-12 rounded-lg"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map;
let userMarker = null;
let searchTimeout = null;
let hotspotMarkers = [];
let userLat = null;
let userLng = null;

function getDemandClass(level) {
    if (level === 'high') return 'demand-high';
    if (level === 'medium') return 'demand-medium';
    return 'demand-low';
}

function createHotspotMarker(hotspot) {
    const size = 22 + (hotspot.demand * 6);
    const hasFlights = hotspot.flightsNearby && hotspot.flightsNearby > 0;
    const hasEvent = hotspot.eventBoost && hotspot.eventBoost > 1.0;
    const shouldPulse = hotspot.isPeak || hasFlights || hasEvent;
    
    let badgeHtml = '';
    if (hasFlights) {
        badgeHtml = '<span style="position:absolute;top:-8px;right:-8px;background:#3b82f6;color:white;font-size:9px;font-weight:bold;padding:2px 4px;border-radius:8px;">âœˆ ' + hotspot.flightsNearby + '</span>';
    } else if (hasEvent) {
        badgeHtml = '<span style="position:absolute;top:-8px;right:-8px;background:linear-gradient(135deg,#8b5cf6,#ec4899);color:white;font-size:9px;font-weight:bold;padding:2px 4px;border-radius:8px;">ðŸŽ«</span>';
    }
    
    const icon = L.divIcon({
        className: '',
        html: `<div class="hotspot-marker ${getDemandClass(hotspot.level)} ${shouldPulse ? 'pulse-animation' : ''}" style="width:${size}px;height:${size}px;">
            ${badgeHtml}
        </div>`,
        iconSize: [size, size],
        iconAnchor: [size/2, size/2]
    });
    
    const marker = L.marker([hotspot.lat, hotspot.lng], { icon });
    
    const distanceText = hotspot.distance !== undefined ? `<p style="color:#3b82f6;font-size:11px;margin-top:4px;">${hotspot.distance.toFixed(1)} km away</p>` : '';
    const peakBadge = hotspot.isPeak ? '<span class="peak-badge">Peak Time</span>' : '';
    const flightBadge = hasFlights ? `<span style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600;margin-left:4px;">âœˆ ${hotspot.flightsNearby} FLIGHTS</span>` : '';
    const eventBadge = hasEvent ? `<span style="background:linear-gradient(135deg,#8b5cf6,#ec4899);color:white;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600;margin-left:4px;">ðŸŽ« EVENT</span>` : '';
    const flightBoostText = hotspot.flightBoost ? `<p style="color:#3b82f6;font-size:11px;margin-top:4px;font-weight:600;">Flight boost: +${Math.round((hotspot.flightBoost - 1) * 100)}% demand</p>` : '';
    const eventBoostText = hasEvent ? `<p style="color:#8b5cf6;font-size:11px;margin-top:4px;font-weight:600;">Event boost: +${Math.round((hotspot.eventBoost - 1) * 100)}% demand</p>` : '';
    
    marker.bindPopup(`
        <div style="padding:12px;min-width:220px;">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;flex-wrap:wrap;">
                <h3 style="font-weight:bold;font-size:14px;margin:0;">${hotspot.name}</h3>
                ${peakBadge}
                ${flightBadge}
                ${eventBadge}
            </div>
            <p style="color:#666;font-size:12px;margin:0 0 8px 0;text-transform:capitalize;">${hotspot.type}</p>
            <p style="color:#888;font-size:11px;margin:0;">${hotspot.description}</p>
            ${distanceText}
            ${flightBoostText}
            ${eventBoostText}
            <div style="margin-top:10px;padding-top:10px;border-top:1px solid #eee;display:flex;align-items:center;justify-content:space-between;">
                <span style="font-weight:600;color:${hotspot.color};">${hotspot.level.charAt(0).toUpperCase() + hotspot.level.slice(1)} Demand</span>
                <span style="font-weight:bold;font-size:16px;">${hotspot.demand.toFixed(1)}x</span>
            </div>
        </div>
    `);
    
    return marker;
}

function setUserLocation(lat, lng) {
    userLat = lat;
    userLng = lng;
    
    if (userMarker) {
        map.removeLayer(userMarker);
    }
    const icon = L.divIcon({
        className: '',
        html: '<div class="user-location-marker"></div>',
        iconSize: [16, 16],
        iconAnchor: [8, 8]
    });
    userMarker = L.marker([lat, lng], { icon }).addTo(map);
    userMarker.bindPopup('<b>Your Location</b>').openPopup();
    map.setView([lat, lng], 13);
    
    fetchHotspots();
}

function getUserLocation() {
    const statusEl = document.getElementById('location-status');
    statusEl.textContent = 'Getting your location...';
    
    if (!navigator.geolocation) {
        statusEl.textContent = 'Geolocation not supported by your browser';
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        (position) => {
            const { latitude, longitude } = position.coords;
            setUserLocation(latitude, longitude);
            statusEl.textContent = 'Showing hotspots near your location';
        },
        (error) => {
            console.log('Geolocation error:', error);
            statusEl.textContent = 'Could not get location. Showing all hotspots.';
            fetchHotspots();
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

async function fetchHotspots() {
    try {
        let url = '/api/hotspots';
        if (userLat !== null && userLng !== null) {
            url += `?lat=${userLat}&lng=${userLng}&max_distance=200`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            updateUI(data);
        } else {
            console.error('Failed to fetch hotspots:', data);
        }
    } catch (e) {
        console.error('Error fetching hotspots:', e);
    }
}

function updateUI(data) {
    hotspotMarkers.forEach(m => map.removeLayer(m));
    hotspotMarkers = [];
    
    data.hotspots.forEach(h => {
        const marker = createHotspotMarker(h);
        marker.addTo(map);
        hotspotMarkers.push(marker);
    });
    
    const analysis = data.analysis;
    document.getElementById('time-period').textContent = analysis.timePeriod;
    document.getElementById('day-type').textContent = `${analysis.dayName} (${analysis.dayType})`;
    
    const weatherEl = document.getElementById('weather-info');
    if (analysis.weather) {
        const boost = analysis.weatherMultiplier > 1.1 ? ` (+${Math.round((analysis.weatherMultiplier - 1) * 100)}%)` : '';
        weatherEl.innerHTML = `<span class="weather-badge">${analysis.weather}${boost}</span>`;
    } else {
        weatherEl.textContent = 'Checking...';
    }
    
    const overallEl = document.getElementById('overall-demand');
    const levelLabels = { high: 'High Demand', medium: 'Medium', low: 'Low' };
    const levelClasses = {
        high: 'bg-red-100 text-red-700',
        medium: 'bg-amber-100 text-amber-700',
        low: 'bg-green-100 text-green-700'
    };
    overallEl.textContent = levelLabels[analysis.overallLevel] || 'Unknown';
    overallEl.className = `px-2 py-0.5 text-xs font-bold rounded-full ${levelClasses[analysis.overallLevel] || 'bg-zinc-100 text-zinc-700'}`;
    
    // Flight info display
    const flightsEl = document.getElementById('flights-info');
    if (analysis.flightsNextHour && analysis.flightsNextHour > 0) {
        const boost = analysis.flightBoost ? ` (+${Math.round((analysis.flightBoost - 1) * 100)}%)` : '';
        const nextFlight = analysis.nextFlight;
        const nextText = nextFlight ? ` - next in ${nextFlight.mins}m` : '';
        flightsEl.innerHTML = `<span class="inline-flex items-center gap-1 px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">âœˆ ${analysis.flightsNextHour}${nextText}${boost}</span>`;
    } else {
        flightsEl.innerHTML = '<span class="text-zinc-400 text-xs">No flights soon</span>';
    }
    
    // Events info display
    const eventsEl = document.getElementById('events-info');
    if (eventsEl) {
        if (analysis.todayEventsCount && analysis.todayEventsCount > 0) {
            const venues = analysis.eventVenuesBoost ? analysis.eventVenuesBoost.join(', ') : '';
            eventsEl.innerHTML = `<span class="inline-flex items-center gap-1 px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full text-xs font-bold">ðŸŽ« ${analysis.todayEventsCount} event${analysis.todayEventsCount > 1 ? 's' : ''} today</span>`;
        } else {
            eventsEl.innerHTML = '<span class="text-zinc-400 text-xs">No events today</span>';
        }
    }
    
    const topHotspotsEl = document.getElementById('top-hotspots');
    topHotspotsEl.innerHTML = data.hotspots.slice(0, 5).map(h => {
        const distanceText = h.distance !== undefined ? `<p class="text-[10px] text-blue-500 font-medium">${h.distance.toFixed(1)} km away</p>` : '';
        const peakBadge = h.isPeak ? '<span class="peak-badge ml-2">Peak</span>' : '';
        const flightBadge = h.flightsNearby && h.flightsNearby > 0 ? `<span class="ml-1 px-1.5 py-0.5 bg-blue-500 text-white text-[9px] font-bold rounded">âœˆ ${h.flightsNearby}</span>` : '';
        const eventBadge = h.eventBoost && h.eventBoost > 1.0 ? `<span class="ml-1 px-1.5 py-0.5 text-white text-[9px] font-bold rounded" style="background:linear-gradient(135deg,#8b5cf6,#ec4899);">ðŸŽ«</span>` : '';
        return `
            <div class="hotspot-card flex items-center justify-between p-3 bg-zinc-50 rounded-lg cursor-pointer hover:bg-zinc-100" onclick="map.setView([${h.lat}, ${h.lng}], 15)">
                <div>
                    <div class="flex items-center flex-wrap gap-1">
                        <p class="text-sm font-semibold text-zinc-900">${h.name}</p>
                        ${peakBadge}
                        ${flightBadge}
                        ${eventBadge}
                    </div>
                    <p class="text-xs text-zinc-500 capitalize">${h.type}</p>
                    ${distanceText}
                </div>
                <span class="px-2 py-1 text-xs font-bold rounded-full ${levelClasses[h.level]}">${h.demand.toFixed(1)}x</span>
            </div>
        `;
    }).join('');
    
    const tipsEl = document.getElementById('tips');
    if (data.tips && data.tips.length > 0) {
        tipsEl.innerHTML = data.tips.map(tip => `
            <p class="flex items-start gap-2">
                <svg class="w-4 h-4 text-blue-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
                <span>${tip}</span>
            </p>
        `).join('');
    }
    
    document.getElementById('last-updated').textContent = `Updated ${analysis.updated || 'now'}`;
}

async function searchLocation(query) {
    if (!query || query.length < 3) return [];
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
        return await response.json();
    } catch (e) {
        console.error('Search error:', e);
        return [];
    }
}

function initMap() {
    map = L.map('map').setView([-31.9505, 115.8605], 12);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);
    
    setTimeout(() => {
        map.invalidateSize();
        getUserLocation();
    }, 100);
    
    const searchInput = document.getElementById('location-search');
    const searchResults = document.getElementById('search-results');
    
    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        
        if (query.length < 3) {
            searchResults.classList.remove('active');
            return;
        }
        
        searchTimeout = setTimeout(async () => {
            const results = await searchLocation(query);
            if (results.length > 0) {
                searchResults.innerHTML = results.map(r => `
                    <div class="search-result-item" data-lat="${r.lat}" data-lng="${r.lon}">
                        ${r.display_name}
                    </div>
                `).join('');
                searchResults.classList.add('active');
            } else {
                searchResults.innerHTML = '<div class="search-result-item">No results found</div>';
                searchResults.classList.add('active');
            }
        }, 300);
    });
    
    searchResults.addEventListener('click', (e) => {
        const item = e.target.closest('.search-result-item');
        if (item && item.dataset.lat) {
            const lat = parseFloat(item.dataset.lat);
            const lng = parseFloat(item.dataset.lng);
            setUserLocation(lat, lng);
            searchInput.value = '';
            searchResults.classList.remove('active');
        }
    });
    
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) {
            searchResults.classList.remove('active');
        }
    });
    
    document.getElementById('my-location-btn').addEventListener('click', getUserLocation);
    
    setInterval(fetchHotspots, 60000);
}

document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}
