{% extends "base.html" %}

{% block title %}Demand Hotspots - RizTar{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 550px;
        width: 100%;
        border-radius: 16px;
        z-index: 1;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: #e5e7eb;
    }
    .leaflet-container {
        background: #e5e7eb !important;
        font-family: 'Inter', sans-serif;
    }
    .leaflet-tile-pane {
        opacity: 1 !important;
    }
    .hotspot-marker {
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .demand-high { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .demand-medium { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .demand-low { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }
    .pulse-animation {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }
    .user-location-marker {
        width: 16px;
        height: 16px;
        background: #3b82f6;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3), 0 2px 8px rgba(0,0,0,0.3);
    }
    .search-container {
        position: relative;
    }
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    .search-results.active {
        display: block;
    }
    .search-result-item {
        padding: 10px 14px;
        cursor: pointer;
        border-bottom: 1px solid #f4f4f5;
        font-size: 13px;
    }
    .search-result-item:hover {
        background: #f4f4f5;
    }
    .search-result-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-zinc-900 mb-2">Demand Hotspots</h1>
        <p class="text-zinc-500">Smart predictions based on time, location, and patterns</p>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2">
            <div class="glass-panel rounded-2xl p-6 premium-shadow">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
                    <h2 class="text-lg font-bold text-zinc-900">Live Hotspot Map</h2>
                    <div class="flex items-center gap-4 text-xs">
                        <div class="flex items-center gap-1.5">
                            <span class="legend-dot demand-high"></span>
                            <span class="text-zinc-600">High</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="legend-dot demand-medium"></span>
                            <span class="text-zinc-600">Medium</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="legend-dot demand-low"></span>
                            <span class="text-zinc-600">Low</span>
                        </div>
                    </div>
                </div>
                
                <div class="search-container mb-4">
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <input type="text" id="location-search" placeholder="Search for a location..." 
                            class="w-full pl-10 pr-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-zinc-400 focus:ring-4 focus:ring-zinc-100 transition-all">
                        <button id="my-location-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors" title="Go to my location">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </button>
                    </div>
                    <div id="search-results" class="search-results"></div>
                </div>
                
                <div id="map"></div>
                <p id="location-status" class="text-xs text-zinc-400 mt-2 text-center"></p>
            </div>
        </div>

        <div class="space-y-6">
            <div class="glass-panel rounded-2xl p-6 premium-shadow">
                <h3 class="text-lg font-bold text-zinc-900 mb-4">Current Time Analysis</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-zinc-500">Time Period</span>
                        <span id="time-period" class="text-sm font-semibold text-zinc-900">Loading...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-zinc-500">Day Type</span>
                        <span id="day-type" class="text-sm font-semibold text-zinc-900">Loading...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-zinc-500">Overall Demand</span>
                        <span id="overall-demand" class="px-2 py-0.5 text-xs font-bold rounded-full">Loading...</span>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-6 premium-shadow">
                <h3 class="text-lg font-bold text-zinc-900 mb-4">Top Hotspots Now</h3>
                <div id="top-hotspots" class="space-y-3">
                    <div class="animate-pulse bg-zinc-100 h-12 rounded-lg"></div>
                    <div class="animate-pulse bg-zinc-100 h-12 rounded-lg"></div>
                    <div class="animate-pulse bg-zinc-100 h-12 rounded-lg"></div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-6 premium-shadow">
                <h3 class="text-lg font-bold text-zinc-900 mb-4">Quick Tips</h3>
                <div id="tips" class="space-y-2 text-sm text-zinc-600">
                    <p class="flex items-start gap-2">
                        <svg class="w-4 h-4 text-blue-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        <span>Position yourself near high-demand zones 10-15 minutes before peak times</span>
                    </p>
                    <p class="flex items-start gap-2">
                        <svg class="w-4 h-4 text-blue-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        <span>Airport pickups tend to surge after major flight arrivals</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map;
let userMarker = null;
let searchTimeout = null;

const HOTSPOTS = [
    { name: "Airport Terminal", lat: 31.5204, lng: 74.3587, type: "airport", baseMultiplier: 1.5, peakHours: [6,7,8,9,18,19,20,21,22] },
    { name: "Downtown Business", lat: 31.5497, lng: 74.3436, type: "business", baseMultiplier: 1.3, peakHours: [8,9,17,18,19] },
    { name: "Mall of Lahore", lat: 31.4697, lng: 74.2728, type: "shopping", baseMultiplier: 1.2, peakHours: [12,13,14,18,19,20,21] },
    { name: "Gulberg Main Market", lat: 31.5127, lng: 74.3407, type: "shopping", baseMultiplier: 1.2, peakHours: [11,12,17,18,19,20] },
    { name: "Model Town", lat: 31.4823, lng: 74.3155, type: "residential", baseMultiplier: 1.0, peakHours: [7,8,9,17,18] },
    { name: "Liberty Market", lat: 31.5082, lng: 74.3359, type: "entertainment", baseMultiplier: 1.4, peakHours: [18,19,20,21,22,23] },
    { name: "DHA Phase 5", lat: 31.4663, lng: 74.3957, type: "residential", baseMultiplier: 1.1, peakHours: [7,8,9,18,19,20] },
    { name: "Railway Station", lat: 31.5669, lng: 74.3097, type: "transit", baseMultiplier: 1.4, peakHours: [6,7,8,9,10,17,18,19,20] },
    { name: "Expo Center", lat: 31.4721, lng: 74.3719, type: "events", baseMultiplier: 1.0, peakHours: [9,10,11,16,17,18] },
    { name: "Food Street", lat: 31.5827, lng: 74.3294, type: "entertainment", baseMultiplier: 1.3, peakHours: [19,20,21,22,23,0] }
];

function getTimePeriod(hour) {
    if (hour >= 5 && hour < 9) return { name: "Morning Rush", multiplier: 1.4 };
    if (hour >= 9 && hour < 12) return { name: "Late Morning", multiplier: 0.9 };
    if (hour >= 12 && hour < 14) return { name: "Lunch Time", multiplier: 1.2 };
    if (hour >= 14 && hour < 17) return { name: "Afternoon", multiplier: 0.8 };
    if (hour >= 17 && hour < 20) return { name: "Evening Rush", multiplier: 1.5 };
    if (hour >= 20 && hour < 24) return { name: "Night Life", multiplier: 1.3 };
    return { name: "Late Night", multiplier: 0.6 };
}

function getDayType(day) {
    if (day === 0) return { name: "Sunday", multiplier: 0.9 };
    if (day === 5) return { name: "Friday", multiplier: 1.3 };
    if (day === 6) return { name: "Saturday", multiplier: 1.1 };
    return { name: "Weekday", multiplier: 1.0 };
}

function calculateDemand(hotspot, hour, day) {
    const timePeriod = getTimePeriod(hour);
    const dayType = getDayType(day);
    const isPeakHour = hotspot.peakHours.includes(hour);
    let demand = hotspot.baseMultiplier * timePeriod.multiplier * dayType.multiplier;
    if (isPeakHour) demand *= 1.5;
    return Math.min(demand, 3.0);
}

function getDemandLevel(demand) {
    if (demand >= 2.0) return { level: "high", color: "#ef4444", class: "demand-high", label: "High Demand" };
    if (demand >= 1.2) return { level: "medium", color: "#f59e0b", class: "demand-medium", label: "Medium Demand" };
    return { level: "low", color: "#22c55e", class: "demand-low", label: "Low Demand" };
}

function createHotspotMarker(hotspot, demand) {
    const demandInfo = getDemandLevel(demand);
    const size = 20 + (demand * 8);
    const icon = L.divIcon({
        className: '',
        html: `<div class="hotspot-marker ${demandInfo.class} pulse-animation" style="width:${size}px;height:${size}px;"></div>`,
        iconSize: [size, size],
        iconAnchor: [size/2, size/2]
    });
    return L.marker([hotspot.lat, hotspot.lng], { icon })
        .bindPopup(`
            <div style="min-width:180px;">
                <h3 style="font-weight:bold;margin-bottom:4px;">${hotspot.name}</h3>
                <p style="color:#666;font-size:12px;margin-bottom:8px;">${hotspot.type.charAt(0).toUpperCase() + hotspot.type.slice(1)}</p>
                <div style="display:flex;align-items:center;gap:6px;">
                    <span style="width:10px;height:10px;border-radius:50%;background:${demandInfo.color};"></span>
                    <span style="font-weight:600;">${demandInfo.label}</span>
                </div>
                <p style="color:#888;font-size:11px;margin-top:6px;">Surge factor: ${demand.toFixed(1)}x</p>
            </div>
        `);
}

function setUserLocation(lat, lng) {
    if (userMarker) {
        map.removeLayer(userMarker);
    }
    const icon = L.divIcon({
        className: '',
        html: '<div class="user-location-marker"></div>',
        iconSize: [16, 16],
        iconAnchor: [8, 8]
    });
    userMarker = L.marker([lat, lng], { icon }).addTo(map);
    userMarker.bindPopup('<b>Your Location</b>').openPopup();
    map.setView([lat, lng], 14);
    
    // Sort and update sidebar based on distance to user
    updateHotspotsSidebar(lat, lng);
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius of the earth in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function updateHotspotsSidebar(userLat, userLng) {
    const now = new Date();
    const hour = now.getHours();
    const day = now.getDay();
    
    const hotspotData = HOTSPOTS.map(h => {
        const demand = calculateDemand(h, hour, day);
        let distance = null;
        if (userLat !== undefined && userLng !== undefined) {
            distance = calculateDistance(userLat, userLng, h.lat, h.lng);
        }
        return { ...h, demand, distance };
    });

    // If user location is available, prioritize distance (within 10km) then demand
    // Otherwise just sort by demand
    hotspotData.sort((a, b) => {
        if (a.distance !== null && b.distance !== null) {
            // If both are within a reasonable "nearby" range (e.g. 15km), prioritize demand
            // Otherwise prioritize distance
            if (a.distance < 15 && b.distance < 15) {
                return b.demand - a.demand;
            }
            return a.distance - b.distance;
        }
        return b.demand - a.demand;
    });
    
    const topHotspotsEl = document.getElementById('top-hotspots');
    topHotspotsEl.innerHTML = hotspotData.slice(0, 5).map(h => {
        const demandInfo = getDemandLevel(h.demand);
        const distanceText = h.distance !== null ? `<p class="text-[10px] text-blue-500 font-medium">${h.distance.toFixed(1)} km away</p>` : '';
        return `
            <div class="flex items-center justify-between p-3 bg-zinc-50 rounded-lg cursor-pointer hover:bg-zinc-100 transition-colors" onclick="map.setView([${h.lat}, ${h.lng}], 15)">
                <div>
                    <p class="text-sm font-semibold text-zinc-900">${h.name}</p>
                    <p class="text-xs text-zinc-500">${h.type.charAt(0).toUpperCase() + h.type.slice(1)}</p>
                    ${distanceText}
                </div>
                <span class="px-2 py-1 text-xs font-bold rounded-full ${
                    demandInfo.level === 'high' ? 'bg-red-100 text-red-700' :
                    demandInfo.level === 'medium' ? 'bg-amber-100 text-amber-700' :
                    'bg-green-100 text-green-700'
                }">${h.demand.toFixed(1)}x</span>
            </div>
        `;
    }).join('');
}

function getUserLocation() {
    const statusEl = document.getElementById('location-status');
    statusEl.textContent = 'Getting your location...';
    
    if (!navigator.geolocation) {
        statusEl.textContent = 'Geolocation not supported by your browser';
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        (position) => {
            const { latitude, longitude } = position.coords;
            setUserLocation(latitude, longitude);
            statusEl.textContent = 'Showing your current location';
        },
        (error) => {
            console.log('Geolocation error:', error);
            statusEl.textContent = 'Could not get your location. Using default view.';
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

async function searchLocation(query) {
    if (!query || query.length < 3) return [];
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
        return await response.json();
    } catch (e) {
        console.error('Search error:', e);
        return [];
    }
}

function initMap() {
    map = L.map('map').setView([31.5204, 74.3587], 12);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);
    
    const now = new Date();
    const hour = now.getHours();
    const day = now.getDay();
    
    const timePeriod = getTimePeriod(hour);
    const dayType = getDayType(day);
    
    document.getElementById('time-period').textContent = timePeriod.name;
    document.getElementById('day-type').textContent = dayType.name;
    
    const hotspotData = HOTSPOTS.map(h => ({
        ...h,
        demand: calculateDemand(h, hour, day)
    })).sort((a, b) => b.demand - a.demand);
    
    const avgDemand = hotspotData.reduce((sum, h) => sum + h.demand, 0) / hotspotData.length;
    const overallDemandInfo = getDemandLevel(avgDemand);
    const overallEl = document.getElementById('overall-demand');
    overallEl.textContent = overallDemandInfo.label;
    overallEl.className = `px-2 py-0.5 text-xs font-bold rounded-full ${
        overallDemandInfo.level === 'high' ? 'bg-red-100 text-red-700' :
        overallDemandInfo.level === 'medium' ? 'bg-amber-100 text-amber-700' :
        'bg-green-100 text-green-700'
    }`;
    
    hotspotData.forEach(h => {
        createHotspotMarker(h, h.demand).addTo(map);
    });
    
    const topHotspotsEl = document.getElementById('top-hotspots');
    topHotspotsEl.innerHTML = hotspotData.slice(0, 5).map(h => {
        const demandInfo = getDemandLevel(h.demand);
        return `
            <div class="flex items-center justify-between p-3 bg-zinc-50 rounded-lg cursor-pointer hover:bg-zinc-100 transition-colors" onclick="map.setView([${h.lat}, ${h.lng}], 15)">
                <div>
                    <p class="text-sm font-semibold text-zinc-900">${h.name}</p>
                    <p class="text-xs text-zinc-500">${h.type.charAt(0).toUpperCase() + h.type.slice(1)}</p>
                </div>
                <span class="px-2 py-1 text-xs font-bold rounded-full ${
                    demandInfo.level === 'high' ? 'bg-red-100 text-red-700' :
                    demandInfo.level === 'medium' ? 'bg-amber-100 text-amber-700' :
                    'bg-green-100 text-green-700'
                }">${h.demand.toFixed(1)}x</span>
            </div>
        `;
    }).join('');
    
    setTimeout(() => {
        map.invalidateSize();
        getUserLocation();
    }, 100);
    
    const searchInput = document.getElementById('location-search');
    const searchResults = document.getElementById('search-results');
    
    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        
        if (query.length < 3) {
            searchResults.classList.remove('active');
            return;
        }
        
        searchTimeout = setTimeout(async () => {
            const results = await searchLocation(query);
            if (results.length > 0) {
                searchResults.innerHTML = results.map(r => `
                    <div class="search-result-item" data-lat="${r.lat}" data-lng="${r.lon}">
                        ${r.display_name}
                    </div>
                `).join('');
                searchResults.classList.add('active');
            } else {
                searchResults.innerHTML = '<div class="search-result-item">No results found</div>';
                searchResults.classList.add('active');
            }
        }, 300);
    });
    
    searchResults.addEventListener('click', (e) => {
        const item = e.target.closest('.search-result-item');
        if (item && item.dataset.lat) {
            const lat = parseFloat(item.dataset.lat);
            const lng = parseFloat(item.dataset.lng);
            map.setView([lat, lng], 14);
            searchInput.value = '';
            searchResults.classList.remove('active');
        }
    });
    
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) {
            searchResults.classList.remove('active');
        }
    });
    
    document.getElementById('my-location-btn').addEventListener('click', getUserLocation);
}

document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}
