{% extends "base.html" %}

{% block title %}Konvoy | Ride Details{% endblock %}

{% block extra_styles %}
<style>
.connection-line {
    position: relative;
    width: 100px;
    height: 2px;
    background: linear-gradient(90deg, #e4e4e7, #a1a1aa, #e4e4e7);
}

.dot {
    position: absolute;
    width: 6px;
    height: 6px;
    background: #000;
    border-radius: 50%;
    top: -2px;
    animation: travel 2s ease-in-out infinite;
}

.dot:nth-child(1) { animation-delay: 0s; }
.dot:nth-child(2) { animation-delay: 0.4s; }
.dot:nth-child(3) { animation-delay: 0.8s; }

@keyframes travel {
    0% { left: 0; opacity: 0; transform: scale(0.5); }
    10% { opacity: 1; transform: scale(1); }
    90% { opacity: 1; transform: scale(1); }
    100% { left: calc(100% - 6px); opacity: 0; transform: scale(0.5); }
}

.pulse-soft {
    animation: pulse-soft 2s ease-in-out infinite;
}

@keyframes pulse-soft {
    0%, 100% { box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.1); }
    50% { box-shadow: 0 0 0 8px rgba(0, 0, 0, 0); }
}

.car-enter {
    animation: car-enter 0.6s ease-out forwards;
}

@keyframes car-enter {
    0% { transform: translateX(20px); opacity: 0; }
    100% { transform: translateX(0); opacity: 1; }
}

.rider-enter {
    animation: rider-enter 0.6s ease-out forwards;
}

@keyframes rider-enter {
    0% { transform: translateX(-20px); opacity: 0; }
    100% { transform: translateX(0); opacity: 1; }
}

.fade-up {
    animation: fade-up 0.5s ease-out forwards;
}

@keyframes fade-up {
    0% { transform: translateY(10px); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
}

.stat-card {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 1px solid #e2e8f0;
}

.fare-highlight {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-[80vh] flex items-center justify-center px-4 py-8">
    <div class="w-full max-w-md">
        {% if not has_permission %}
        <div class="glass-panel p-6 rounded-xl premium-shadow text-center">
            <div class="w-16 h-16 bg-zinc-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
            </div>
            <h2 class="text-lg font-bold text-zinc-900 mb-2">Access Locked</h2>
            <p class="text-sm text-zinc-500 mb-5">You don't have permission to fetch ride details. Contact an administrator to request access.</p>
            <a href="{{ url_for('root') }}" class="block w-full bg-black text-white py-3 rounded-lg font-medium text-sm hover:bg-zinc-800 transition-colors">
                Back to Home
            </a>
        </div>
        {% elif loading %}
        <div id="loading-container" class="glass-panel p-8 rounded-2xl premium-shadow text-center">
            <div class="flex flex-col items-center">
                <div class="relative w-20 h-20 mb-6">
                    <div class="absolute inset-0 border-4 border-zinc-200 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-black rounded-full border-t-transparent animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <svg class="w-8 h-8 text-zinc-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                        </svg>
                    </div>
                </div>
                <h2 class="text-lg font-bold text-zinc-900 mb-2">Fetching Ride Details</h2>
                <p id="loading-status" class="text-sm text-zinc-500">Connecting to Uber...</p>
                <div class="flex items-center gap-1 mt-4">
                    <div class="w-2 h-2 bg-zinc-400 rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                    <div class="w-2 h-2 bg-zinc-400 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                    <div class="w-2 h-2 bg-zinc-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                </div>
            </div>
        </div>
        <div id="ride-content" class="hidden"></div>
        {% else %}
        
        {% if ride_data %}
        <div class="bg-gradient-to-b from-zinc-900 to-zinc-800 rounded-t-2xl p-5">
            <div class="flex items-center justify-between mb-4">
                <span class="text-zinc-400 text-xs font-medium uppercase tracking-wide">{{ ride_data.trip_status }}</span>
                <div class="flex items-center gap-2">
                    {% if ride_data.ride_type_image %}
                    <img src="{{ ride_data.ride_type_image }}" alt="{{ ride_data.ride_type }}" class="w-10 h-6 object-contain">
                    {% endif %}
                    <span class="px-2 py-0.5 bg-white/10 text-white rounded text-xs font-medium">{{ ride_data.ride_type }}</span>
                </div>
            </div>
            
            <div class="flex items-center justify-center py-4">
                <div class="rider-enter flex flex-col items-center">
                    <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center text-zinc-800 text-base font-bold shadow-lg pulse-soft">
                        {% set name_parts = ride_data.full_name.split() %}
                        {{ name_parts[0][0] }}{% if name_parts|length > 1 %}{{ name_parts[1][0] }}{% endif %}
                    </div>
                    <p class="text-white text-sm font-medium mt-2">{{ ride_data.full_name }}</p>
                    <div class="flex items-center mt-1">
                        <svg class="w-3 h-3 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <span class="text-yellow-400 text-xs font-medium">{{ ride_data.rating }}</span>
                    </div>
                </div>
                
                <div class="connection-line mx-6">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
                
                <div class="car-enter flex flex-col items-center">
                    {% if default_vehicle and default_vehicle.imageUrl %}
                    <div class="w-24 h-16 flex items-center justify-center">
                        <img src="{{ default_vehicle.imageUrl }}" alt="Vehicle" class="max-w-full max-h-full object-contain drop-shadow-xl">
                    </div>
                    {% else %}
                    <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center">
                        <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                        </svg>
                    </div>
                    {% endif %}
                    {% if default_vehicle %}
                    <p class="text-white text-sm font-medium mt-2">{{ default_vehicle.make }}</p>
                    <p class="text-zinc-400 text-xs">{{ default_vehicle.model }}</p>
                    {% else %}
                    <p class="text-white text-sm font-medium mt-2">Your Car</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="bg-white shadow-xl">
            {% if ride_data.fare_price or ride_data.eta_minutes or ride_data.fare_distance or ride_data.trip_distance %}
            <div class="grid grid-cols-3 gap-0 border-b border-zinc-100">
                <div class="p-4 text-center border-r border-zinc-100">
                    <div class="flex items-center justify-center mb-1">
                        <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <p class="text-lg font-bold text-zinc-900">{{ ride_data.fare_price or '--' }}</p>
                    <p class="text-xs text-zinc-400">Fare</p>
                </div>
                <div class="p-4 text-center border-r border-zinc-100">
                    <div class="flex items-center justify-center mb-1">
                        <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <p class="text-lg font-bold text-zinc-900">{{ ride_data.eta_minutes or '--' }}</p>
                    <p class="text-xs text-zinc-400">ETA</p>
                </div>
                <div class="p-4 text-center">
                    <div class="flex items-center justify-center mb-1">
                        <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                        </svg>
                    </div>
                    <p class="text-lg font-bold text-zinc-900">{{ ride_data.fare_distance or (ride_data.trip_distance ~ ' km' if ride_data.trip_distance else '--') }}</p>
                    <p class="text-xs text-zinc-400">Distance</p>
                </div>
            </div>
            {% endif %}
            
            <div class="p-5">
                <div class="space-y-4 fade-up" style="animation-delay: 0.3s;">
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-zinc-100 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <div class="w-2 h-2 bg-black rounded-full"></div>
                        </div>
                        <div class="flex-1 pt-1">
                            <p class="text-xs text-zinc-400 mb-0.5">Pickup</p>
                            <p class="text-sm text-zinc-800 font-medium">{{ ride_data.pickup_address }}</p>
                        </div>
                    </div>
                    
                    <div class="ml-4 border-l-2 border-dashed border-zinc-200 h-4"></div>
                    
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                        </div>
                        <div class="flex-1 pt-1">
                            <p class="text-xs text-zinc-400 mb-0.5">Drop-off</p>
                            <p class="text-sm text-zinc-800 font-medium">{{ ride_data.drop_off_address }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-b-2xl shadow-xl px-5 pb-5">
            <a href="{{ url_for('root') }}" class="block w-full bg-black text-white py-3 rounded-xl font-semibold text-sm text-center hover:bg-zinc-800 transition-colors">
                Back to Home
            </a>
        </div>
        
        {% else %}
        <div class="glass-panel p-6 rounded-2xl premium-shadow">
            <div class="flex items-center justify-center py-8">
                <div class="flex flex-col items-center">
                    <div class="w-14 h-14 bg-zinc-100 rounded-full flex items-center justify-center mb-2">
                        <svg class="w-7 h-7 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                    <span class="text-xs text-zinc-400">Rider</span>
                </div>
                
                <div class="mx-4 flex items-center">
                    <div class="w-2 h-2 bg-zinc-200 rounded-full mx-1"></div>
                    <div class="w-2 h-2 bg-zinc-300 rounded-full mx-1"></div>
                    <div class="w-2 h-2 bg-zinc-200 rounded-full mx-1"></div>
                </div>
                
                <div class="flex flex-col items-center">
                    {% if default_vehicle and default_vehicle.imageUrl %}
                    <img src="{{ default_vehicle.imageUrl }}" alt="Vehicle" class="w-16 h-10 object-contain opacity-40">
                    {% else %}
                    <div class="w-14 h-14 bg-zinc-100 rounded-full flex items-center justify-center mb-2">
                        <svg class="w-7 h-7 text-zinc-400" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                        </svg>
                    </div>
                    {% endif %}
                    <span class="text-xs text-zinc-400 mt-2">Your Car</span>
                </div>
            </div>
            
            <div class="text-center">
                <p class="text-base font-semibold text-zinc-800">No active ride</p>
                <p class="text-sm text-zinc-500 mt-1">Waiting for ride requests...</p>
            </div>
            
            <a href="{{ url_for('root') }}" class="block w-full mt-6 bg-black text-white py-3 rounded-xl font-semibold text-sm text-center hover:bg-zinc-800 transition-colors">
                Back to Home
            </a>
        </div>
        {% endif %}
        
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{% if loading %}
<script>
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

const statusMessages = [
    'Connecting to Uber...',
    'Authenticating session...',
    'Fetching ride information...',
    'Processing data...'
];
let msgIndex = 0;

const statusInterval = setInterval(() => {
    msgIndex = (msgIndex + 1) % statusMessages.length;
    const statusEl = document.getElementById('loading-status');
    if (statusEl) statusEl.textContent = statusMessages[msgIndex];
}, 1500);

fetch('/api/fetch-ride-data')
    .then(response => response.json())
    .then(data => {
        clearInterval(statusInterval);
        const loadingEl = document.getElementById('loading-container');
        const contentEl = document.getElementById('ride-content');
        
        if (data.ride_data) {
            const rd = data.ride_data;
            const dv = data.default_vehicle;
            const fullName = escapeHtml(rd.full_name);
            const nameParts = rd.full_name.split(' ');
            const initials = escapeHtml(nameParts[0][0] + (nameParts.length > 1 ? nameParts[1][0] : ''));
            
            contentEl.innerHTML = `
                <div class="bg-gradient-to-b from-zinc-900 to-zinc-800 rounded-t-2xl p-5">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-zinc-400 text-xs font-medium uppercase tracking-wide">${escapeHtml(rd.trip_status) || ''}</span>
                        <div class="flex items-center gap-2">
                            ${rd.ride_type_image ? `<img src="${escapeHtml(rd.ride_type_image)}" alt="${escapeHtml(rd.ride_type)}" class="w-10 h-6 object-contain">` : ''}
                            <span class="px-2 py-0.5 bg-white/10 text-white rounded text-xs font-medium">${escapeHtml(rd.ride_type)}</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-center py-4">
                        <div class="rider-enter flex flex-col items-center">
                            <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center text-zinc-800 text-base font-bold shadow-lg pulse-soft">
                                ${initials}
                            </div>
                            <p class="text-white text-sm font-medium mt-2">${fullName}</p>
                            <div class="flex items-center mt-1">
                                <svg class="w-3 h-3 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                                <span class="text-yellow-400 text-xs font-medium">${escapeHtml(rd.rating)}</span>
                            </div>
                        </div>
                        
                        <div class="connection-line mx-6">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                        
                        <div class="car-enter flex flex-col items-center">
                            ${dv && dv.imageUrl ? `
                                <div class="w-24 h-16 flex items-center justify-center">
                                    <img src="${escapeHtml(dv.imageUrl)}" alt="Vehicle" class="max-w-full max-h-full object-contain drop-shadow-xl">
                                </div>
                            ` : `
                                <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center">
                                    <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </div>
                            `}
                            ${dv ? `
                                <p class="text-white text-sm font-medium mt-2">${escapeHtml(dv.make)}</p>
                                <p class="text-zinc-400 text-xs">${escapeHtml(dv.model)}</p>
                            ` : '<p class="text-white text-sm font-medium mt-2">Your Car</p>'}
                        </div>
                    </div>
                </div>
                
                <div class="bg-white shadow-xl">
                    ${(rd.fare_price || rd.eta_minutes || rd.trip_distance) ? `
                    <div class="grid grid-cols-3 gap-0 border-b border-zinc-100">
                        <div class="p-4 text-center border-r border-zinc-100">
                            <div class="flex items-center justify-center mb-1">
                                <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <p class="text-lg font-bold text-zinc-900">${rd.fare_price || '--'}</p>
                            <p class="text-xs text-zinc-400">Fare</p>
                        </div>
                        <div class="p-4 text-center border-r border-zinc-100">
                            <div class="flex items-center justify-center mb-1">
                                <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <p class="text-lg font-bold text-zinc-900">${rd.eta_minutes ? rd.eta_minutes + ' min' : '--'}</p>
                            <p class="text-xs text-zinc-400">Trip Time</p>
                        </div>
                        <div class="p-4 text-center">
                            <div class="flex items-center justify-center mb-1">
                                <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                                </svg>
                            </div>
                            <p class="text-lg font-bold text-zinc-900">${rd.trip_distance ? rd.trip_distance + ' km' : '--'}</p>
                            <p class="text-xs text-zinc-400">Distance</p>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="p-5">
                        <div class="space-y-4 fade-up" style="animation-delay: 0.3s;">
                            <div class="flex items-start">
                                <div class="w-8 h-8 bg-zinc-100 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                                    <div class="w-2 h-2 bg-black rounded-full"></div>
                                </div>
                                <div class="flex-1 pt-1">
                                    <p class="text-xs text-zinc-400 mb-0.5">Pickup</p>
                                    <p class="text-sm text-zinc-800 font-medium">${escapeHtml(rd.pickup_address)}</p>
                                </div>
                            </div>
                            
                            <div class="ml-4 border-l-2 border-dashed border-zinc-200 h-4"></div>
                            
                            <div class="flex items-start">
                                <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                    </svg>
                                </div>
                                <div class="flex-1 pt-1">
                                    <p class="text-xs text-zinc-400 mb-0.5">Drop-off</p>
                                    <p class="text-sm text-zinc-800 font-medium">${escapeHtml(rd.drop_off_address)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-b-2xl shadow-xl px-5 pb-5">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="refreshRide()" class="bg-zinc-100 text-zinc-800 py-3 rounded-xl font-semibold text-sm text-center hover:bg-zinc-200 transition-colors flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            Refresh
                        </button>
                        <a href="/" class="bg-black text-white py-3 rounded-xl font-semibold text-sm text-center hover:bg-zinc-800 transition-colors">
                            Home
                        </a>
                    </div>
                </div>
            `;
        } else {
            contentEl.innerHTML = `
                <div class="glass-panel p-6 rounded-2xl premium-shadow">
                    <div class="flex items-center justify-center py-8">
                        <div class="flex flex-col items-center">
                            <div class="w-14 h-14 bg-zinc-100 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-7 h-7 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                            </div>
                            <span class="text-xs text-zinc-400">Rider</span>
                        </div>
                        
                        <div class="mx-4 flex items-center">
                            <div class="w-2 h-2 bg-zinc-200 rounded-full mx-1"></div>
                            <div class="w-2 h-2 bg-zinc-300 rounded-full mx-1"></div>
                            <div class="w-2 h-2 bg-zinc-200 rounded-full mx-1"></div>
                        </div>
                        
                        <div class="flex flex-col items-center">
                            <div class="w-14 h-14 bg-zinc-100 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-7 h-7 text-zinc-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                </svg>
                            </div>
                            <span class="text-xs text-zinc-400 mt-2">Your Car</span>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <p class="text-base font-semibold text-zinc-800">No active ride</p>
                        <p class="text-sm text-zinc-500 mt-1">Waiting for ride requests...</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mt-6">
                        <button onclick="refreshRide()" class="bg-zinc-100 text-zinc-800 py-3 rounded-xl font-semibold text-sm text-center hover:bg-zinc-200 transition-colors flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            Refresh
                        </button>
                        <a href="/" class="bg-black text-white py-3 rounded-xl font-semibold text-sm text-center hover:bg-zinc-800 transition-colors">
                            Home
                        </a>
                    </div>
                </div>
            `;
        }
        
        loadingEl.classList.add('hidden');
        contentEl.classList.remove('hidden');
    })
    .catch(error => {
        clearInterval(statusInterval);
        console.error('Error fetching ride data:', error);
        const loadingEl = document.getElementById('loading-container');
        loadingEl.innerHTML = `
            <div class="flex flex-col items-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h2 class="text-lg font-bold text-zinc-900 mb-2">Connection Error</h2>
                <p class="text-sm text-zinc-500 mb-4">Failed to fetch ride details. Please try again.</p>
                <a href="/fetch-ride" class="block w-full bg-black text-white py-3 rounded-xl font-semibold text-sm text-center hover:bg-zinc-800 transition-colors">
                    Retry
                </a>
            </div>
        `;
    });

function refreshRide() {
    window.location.reload();
}

document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        refreshRide();
    }
});
</script>
{% endif %}
{% endblock %}
