{% extends "base.html" %}

{% block title %}RizTar | Ride Details{% endblock %}

{% block extra_styles %}
<style>
.connection-line {
    position: relative;
    width: 80px;
    height: 2px;
    background: linear-gradient(90deg, rgba(255,255,255,0.2), rgba(255,255,255,0.5), rgba(255,255,255,0.2));
}

.dot {
    position: absolute;
    width: 6px;
    height: 6px;
    background: #fff;
    border-radius: 50%;
    top: -2px;
    animation: travel 2s ease-in-out infinite;
}

.dot:nth-child(1) { animation-delay: 0s; }
.dot:nth-child(2) { animation-delay: 0.4s; }
.dot:nth-child(3) { animation-delay: 0.8s; }

@keyframes travel {
    0% { left: 0; opacity: 0; transform: scale(0.5); }
    10% { opacity: 1; transform: scale(1); }
    90% { opacity: 1; transform: scale(1); }
    100% { left: calc(100% - 6px); opacity: 0; transform: scale(0.5); }
}

.pulse-soft {
    animation: pulse-soft 2s ease-in-out infinite;
}

@keyframes pulse-soft {
    0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.3); }
    50% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
}

@keyframes glow-pulse {
    0%, 100% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
    50% { box-shadow: 0 0 35px rgba(16, 185, 129, 0.5); }
}

@keyframes live-pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.7; }
}

.ride-header {
    background: linear-gradient(135deg, #065f46 0%, #047857 50%, #059669 100%);
    animation: glow-pulse 2s ease-in-out infinite;
}

.live-indicator {
    animation: live-pulse 1.5s ease-in-out infinite;
}

.car-enter {
    animation: car-enter 0.6s ease-out forwards;
}

@keyframes car-enter {
    0% { transform: translateX(20px); opacity: 0; }
    100% { transform: translateX(0); opacity: 1; }
}

.rider-enter {
    animation: rider-enter 0.6s ease-out forwards;
}

@keyframes rider-enter {
    0% { transform: translateX(-20px); opacity: 0; }
    100% { transform: translateX(0); opacity: 1; }
}

.fade-up {
    animation: fade-up 0.5s ease-out forwards;
}

@keyframes fade-up {
    0% { transform: translateY(10px); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
}

.stat-card {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 1px solid #e2e8f0;
}

.fare-highlight {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-[80vh] flex items-center justify-center px-4 py-8">
    <div class="w-full max-w-md">
        {% if not has_permission %}
        <div class="glass-panel p-6 rounded-xl premium-shadow text-center">
            <div class="w-16 h-16 bg-zinc-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
            </div>
            <h2 class="text-lg font-bold text-zinc-900 mb-2">Access Locked</h2>
            <p class="text-sm text-zinc-500 mb-5">You don't have permission to fetch ride details. Contact an administrator to request access.</p>
            <a href="{{ url_for('root') }}" class="block w-full bg-black text-white py-3 rounded-lg font-medium text-sm hover:bg-zinc-800 transition-colors">
                Back to Home
            </a>
        </div>
        {% elif loading %}
        <div id="loading-container" class="glass-panel p-8 rounded-2xl premium-shadow text-center">
            <div class="flex flex-col items-center">
                <div class="relative w-20 h-20 mb-6">
                    <div class="absolute inset-0 border-4 border-zinc-200 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-black rounded-full border-t-transparent animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <svg class="w-8 h-8 text-zinc-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                        </svg>
                    </div>
                </div>
                <h2 class="text-lg font-bold text-zinc-900 mb-2">Fetching Ride Details</h2>
                <p id="loading-status" class="text-sm text-zinc-500">Connecting to Uber...</p>
                <div class="flex items-center gap-1 mt-4">
                    <div class="w-2 h-2 bg-zinc-400 rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                    <div class="w-2 h-2 bg-zinc-400 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                    <div class="w-2 h-2 bg-zinc-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                </div>
            </div>
        </div>
        <div id="ride-content" class="hidden"></div>
        {% else %}
        
        {% if ride_data %}
        <div class="ride-header rounded-t-2xl p-5 relative overflow-hidden">
            <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4wNSI+PGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iNCIvPjwvZz48L2c+PC9zdmc+')] opacity-50"></div>
            
            <div class="relative z-10">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="live-indicator w-2 h-2 bg-white rounded-full mr-2"></span>
                        <span class="text-white/80 text-xs font-bold uppercase tracking-wide">{{ ride_data.trip_status }}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        {% if ride_data.ride_type_image %}
                        <img src="{{ ride_data.ride_type_image }}" alt="{{ ride_data.ride_type }}" class="w-10 h-6 object-contain">
                        {% endif %}
                        <span class="px-2 py-0.5 bg-white/20 backdrop-blur-sm text-white rounded-full text-xs font-medium">{{ ride_data.ride_type }}</span>
                    </div>
                </div>
                
                <div class="flex items-center justify-center py-4">
                    <div class="rider-enter flex flex-col items-center">
                        <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center text-emerald-700 text-base font-bold shadow-lg pulse-soft">
                            {% set name_parts = ride_data.full_name.split() %}
                            {{ name_parts[0][0] }}{% if name_parts|length > 1 %}{{ name_parts[1][0] }}{% endif %}
                        </div>
                        <p class="text-white text-sm font-medium mt-2">{{ ride_data.full_name }}</p>
                        <div class="flex items-center mt-1 bg-white/15 px-2 py-0.5 rounded-full">
                            <svg class="w-3 h-3 text-yellow-300 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                            <span class="text-white text-xs font-medium">{{ ride_data.rating }}</span>
                        </div>
                    </div>
                    
                    <div class="connection-line mx-4">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    
                    <div class="car-enter flex flex-col items-center">
                        {% if default_vehicle and default_vehicle.imageUrl %}
                        <div class="w-24 h-16 flex items-center justify-center ">
                            <img src="{{ default_vehicle.imageUrl }}" alt="Vehicle" class="max-w-full max-h-full object-contain drop-shadow-xl">
                        </div>
                        {% else %}
                        <div class="w-16 h-16 bg-white/15 backdrop-blur-sm rounded-full flex items-center justify-center ">
                            <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                            </svg>
                        </div>
                        {% endif %}
                        {% if default_vehicle %}
                        <p class="text-white text-sm font-medium mt-2">{{ default_vehicle.make }}</p>
                        <p class="text-white/60 text-xs">{{ default_vehicle.model }}</p>
                        {% else %}
                        <p class="text-white text-sm font-medium mt-2">Your Car</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bg-white shadow-xl">
            {% if ride_data.fare_price or ride_data.eta_minutes or ride_data.fare_distance or ride_data.trip_distance %}
            <div class="grid grid-cols-3 gap-0 border-b border-zinc-100">
                <div class="p-4 text-center border-r border-zinc-100">
                    <div class="flex items-center justify-center mb-1">
                        <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <p class="text-lg font-bold text-zinc-900">{{ ride_data.fare_price or '--' }}</p>
                    <p class="text-xs text-zinc-400">Fare</p>
                </div>
                <div class="p-4 text-center border-r border-zinc-100">
                    <div class="flex items-center justify-center mb-1">
                        <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <p class="text-lg font-bold text-zinc-900">{{ ride_data.eta_minutes or '--' }}</p>
                    <p class="text-xs text-zinc-400">ETA</p>
                </div>
                <div class="p-4 text-center">
                    <div class="flex items-center justify-center mb-1">
                        <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                        </svg>
                    </div>
                    <p class="text-lg font-bold text-zinc-900">{{ ride_data.fare_distance or (ride_data.trip_distance ~ ' km' if ride_data.trip_distance else '--') }}</p>
                    <p class="text-xs text-zinc-400">Distance</p>
                </div>
            </div>
            {% endif %}
            
            <div class="p-5">
                <div class="space-y-4 fade-up" style="animation-delay: 0.3s;">
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-zinc-100 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <div class="w-2 h-2 bg-black rounded-full"></div>
                        </div>
                        <div class="flex-1 pt-1">
                            <p class="text-xs text-zinc-400 mb-0.5">Pickup</p>
                            <p class="text-sm text-zinc-800 font-medium">{{ ride_data.pickup_address }}</p>
                        </div>
                    </div>
                    
                    <div class="ml-4 border-l-2 border-dashed border-zinc-200 h-4"></div>
                    
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                        </div>
                        <div class="flex-1 pt-1">
                            <p class="text-xs text-zinc-400 mb-0.5">Drop-off</p>
                            <p class="text-sm text-zinc-800 font-medium">{{ ride_data.drop_off_address }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-zinc-100 pt-4 mt-4 space-y-3">
                    <button id="cancel-ride-btn" 
                        data-pickup-lat="{{ ride_data.pickup_coords[0] if ride_data.pickup_coords else '' }}"
                        data-pickup-lng="{{ ride_data.pickup_coords[1] if ride_data.pickup_coords else '' }}"
                        data-dropoff-lat="{{ ride_data.dropoff_coords[0] if ride_data.dropoff_coords else '' }}"
                        data-dropoff-lng="{{ ride_data.dropoff_coords[1] if ride_data.dropoff_coords else '' }}"
                        class="w-full bg-gradient-to-r from-red-600 to-red-500 text-white py-3.5 rounded-xl font-semibold text-sm text-center hover:from-red-700 hover:to-red-600 transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Cancel Ride
                    </button>
                    <div id="simulation-status" class="hidden">
                        <div class="bg-gradient-to-br from-zinc-900 to-zinc-800 rounded-xl p-3 shadow-lg">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-1.5">
                                    <div class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse"></div>
                                    <span class="text-emerald-400 text-[10px] font-bold uppercase tracking-wider">Live</span>
                                </div>
                                <div id="step-counter" class="text-zinc-400 text-[10px] font-medium">Step 1/5</div>
                            </div>
                            <div class="relative mb-2">
                                <div class="flex items-center justify-between">
                                    <div id="pickup-indicator" class="w-6 h-6 rounded-full bg-emerald-500/20 flex items-center justify-center border border-emerald-500">
                                        <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                    </div>
                                    <div class="flex-1 mx-2 relative h-1 bg-zinc-700 rounded-full">
                                        <div id="route-progress" class="absolute left-0 top-0 h-full bg-gradient-to-r from-emerald-500 to-emerald-400 rounded-full transition-all duration-1000" style="width: 0%"></div>
                                        <div id="car-icon" class="absolute top-1/2 -translate-y-1/2 transition-all duration-1000" style="left: 0%">
                                            <div class="w-4 h-4 bg-white rounded-full shadow flex items-center justify-center -mt-0.5">
                                                <svg class="w-2.5 h-2.5 text-zinc-800" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="dropoff-indicator" class="w-6 h-6 rounded-full bg-zinc-700 flex items-center justify-center border border-zinc-600">
                                        <svg class="w-3 h-3 text-zinc-500" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <p id="simulation-message" class="text-white text-xs font-medium text-center"></p>
                        </div>
                    </div>
                    <div id="dropoff-notification" class="hidden">
                        <div class="bg-gradient-to-br from-emerald-600 to-emerald-500 rounded-xl p-3 shadow-lg text-white">
                            <div class="flex items-center justify-center gap-2 mb-2">
                                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                                <div>
                                    <p class="font-bold text-sm">At Dropoff!</p>
                                </div>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2 text-center">
                                <p id="dropoff-countdown" class="text-white/90 text-xs font-medium">Stops in 3m 0s</p>
                                <div class="mt-1.5 h-1 bg-white/20 rounded-full overflow-hidden">
                                    <div id="countdown-bar" class="h-full bg-white rounded-full transition-all duration-1000" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a href="{{ url_for('root') }}" class="block w-full bg-black text-white py-3 rounded-xl font-semibold text-sm text-center hover:bg-zinc-800 transition-colors">
                        Back to Home
                    </a>
                </div>
            </div>
        </div>
        
        {% else %}
        <div class="glass-panel p-6 rounded-2xl premium-shadow">
            <div class="flex items-center justify-center py-8">
                <div class="flex flex-col items-center">
                    <div class="w-14 h-14 bg-zinc-100 rounded-full flex items-center justify-center mb-2">
                        <svg class="w-7 h-7 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                    <span class="text-xs text-zinc-400">Rider</span>
                </div>
                
                <div class="mx-4 flex items-center">
                    <div class="w-2 h-2 bg-zinc-200 rounded-full mx-1"></div>
                    <div class="w-2 h-2 bg-zinc-300 rounded-full mx-1"></div>
                    <div class="w-2 h-2 bg-zinc-200 rounded-full mx-1"></div>
                </div>
                
                <div class="flex flex-col items-center">
                    {% if default_vehicle and default_vehicle.imageUrl %}
                    <img src="{{ default_vehicle.imageUrl }}" alt="Vehicle" class="w-16 h-10 object-contain opacity-40">
                    {% else %}
                    <div class="w-14 h-14 bg-zinc-100 rounded-full flex items-center justify-center mb-2">
                        <svg class="w-7 h-7 text-zinc-400" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                        </svg>
                    </div>
                    {% endif %}
                    <span class="text-xs text-zinc-400 mt-2">Your Car</span>
                </div>
            </div>
            
            <div class="text-center">
                <p class="text-base font-semibold text-zinc-800">No active ride</p>
                <p class="text-sm text-zinc-500 mt-1">Waiting for ride requests...</p>
            </div>
            
            <a href="{{ url_for('root') }}" class="block w-full mt-6 bg-black text-white py-3 rounded-xl font-semibold text-sm text-center hover:bg-zinc-800 transition-colors">
                Back to Home
            </a>
        </div>
        {% endif %}
        
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{% if loading %}
<script>
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

const statusMessages = [
    'Connecting to Uber...',
    'Authenticating session...',
    'Fetching ride information...',
    'Processing data...'
];
let msgIndex = 0;

const statusInterval = setInterval(() => {
    msgIndex = (msgIndex + 1) % statusMessages.length;
    const statusEl = document.getElementById('loading-status');
    if (statusEl) statusEl.textContent = statusMessages[msgIndex];
}, 1500);

fetch('/api/fetch-ride-data')
    .then(response => response.json())
    .then(data => {
        clearInterval(statusInterval);
        const loadingEl = document.getElementById('loading-container');
        const contentEl = document.getElementById('ride-content');
        
        if (data.ride_data) {
            const rd = data.ride_data;
            const dv = data.default_vehicle;
            const fullName = escapeHtml(rd.full_name);
            const nameParts = rd.full_name.split(' ');
            const initials = escapeHtml(nameParts[0][0] + (nameParts.length > 1 ? nameParts[1][0] : ''));
            
            contentEl.innerHTML = `
                <div class="ride-header rounded-t-2xl p-5 relative overflow-hidden">
                    <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4wNSI+PGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iNCIvPjwvZz48L2c+PC9zdmc+')] opacity-50"></div>
                    
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <span class="live-indicator w-2 h-2 bg-white rounded-full mr-2"></span>
                                <span class="text-white/80 text-xs font-bold uppercase tracking-wide">${escapeHtml(rd.trip_status) || ''}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                ${rd.ride_type_image ? `<img src="${escapeHtml(rd.ride_type_image)}" alt="${escapeHtml(rd.ride_type)}" class="w-10 h-6 object-contain">` : ''}
                                <span class="px-2 py-0.5 bg-white/20 backdrop-blur-sm text-white rounded-full text-xs font-medium">${escapeHtml(rd.ride_type)}</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-center py-4">
                            <div class="rider-enter flex flex-col items-center">
                                <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center text-emerald-700 text-base font-bold shadow-lg pulse-soft">
                                    ${initials}
                                </div>
                                <p class="text-white text-sm font-medium mt-2">${fullName}</p>
                                <div class="flex items-center mt-1 bg-white/15 px-2 py-0.5 rounded-full">
                                    <svg class="w-3 h-3 text-yellow-300 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                    <span class="text-white text-xs font-medium">${escapeHtml(rd.rating)}</span>
                                </div>
                            </div>
                            
                            <div class="connection-line mx-4">
                                <div class="dot"></div>
                                <div class="dot"></div>
                                <div class="dot"></div>
                            </div>
                            
                            <div class="car-enter flex flex-col items-center">
                                ${dv && dv.imageUrl ? `
                                    <div class="w-24 h-16 flex items-center justify-center ">
                                        <img src="${escapeHtml(dv.imageUrl)}" alt="Vehicle" class="max-w-full max-h-full object-contain drop-shadow-xl">
                                    </div>
                                ` : `
                                    <div class="w-16 h-16 bg-white/15 backdrop-blur-sm rounded-full flex items-center justify-center ">
                                        <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                        </svg>
                                    </div>
                                `}
                                ${dv ? `
                                    <p class="text-white text-sm font-medium mt-2">${escapeHtml(dv.make)}</p>
                                    <p class="text-white/60 text-xs">${escapeHtml(dv.model)}</p>
                                ` : '<p class="text-white text-sm font-medium mt-2">Your Car</p>'}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white shadow-xl">
                    ${(rd.fare_price || rd.eta_minutes || rd.trip_distance) ? `
                    <div class="grid grid-cols-3 gap-0 border-b border-zinc-100">
                        <div class="p-4 text-center border-r border-zinc-100">
                            <div class="flex items-center justify-center mb-1">
                                <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <p class="text-lg font-bold text-zinc-900">${rd.fare_price || '--'}</p>
                            <p class="text-xs text-zinc-400">Fare</p>
                        </div>
                        <div class="p-4 text-center border-r border-zinc-100">
                            <div class="flex items-center justify-center mb-1">
                                <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <p class="text-lg font-bold text-zinc-900">${rd.eta_minutes ? rd.eta_minutes + ' min' : '--'}</p>
                            <p class="text-xs text-zinc-400">Trip Time</p>
                        </div>
                        <div class="p-4 text-center">
                            <div class="flex items-center justify-center mb-1">
                                <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                                </svg>
                            </div>
                            <p class="text-lg font-bold text-zinc-900">${rd.trip_distance ? rd.trip_distance + ' km' : '--'}</p>
                            <p class="text-xs text-zinc-400">Distance</p>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="p-5">
                        <div class="space-y-4 fade-up" style="animation-delay: 0.3s;">
                            <div class="flex items-start">
                                <div class="w-8 h-8 bg-zinc-100 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                                    <div class="w-2 h-2 bg-black rounded-full"></div>
                                </div>
                                <div class="flex-1 pt-1">
                                    <p class="text-xs text-zinc-400 mb-0.5">Pickup</p>
                                    <p class="text-sm text-zinc-800 font-medium">${escapeHtml(rd.pickup_address)}</p>
                                </div>
                            </div>
                            
                            <div class="ml-4 border-l-2 border-dashed border-zinc-200 h-4"></div>
                            
                            <div class="flex items-start">
                                <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                    </svg>
                                </div>
                                <div class="flex-1 pt-1">
                                    <p class="text-xs text-zinc-400 mb-0.5">Drop-off</p>
                                    <p class="text-sm text-zinc-800 font-medium">${escapeHtml(rd.drop_off_address)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-b-2xl shadow-xl px-5 pb-5 space-y-3">
                    <button id="cancel-ride-btn" 
                            data-pickup-lat="${rd.pickup_coords ? rd.pickup_coords[0] : ''}"
                            data-pickup-lng="${rd.pickup_coords ? rd.pickup_coords[1] : ''}"
                            data-dropoff-lat="${rd.dropoff_coords ? rd.dropoff_coords[0] : ''}"
                            data-dropoff-lng="${rd.dropoff_coords ? rd.dropoff_coords[1] : ''}"
                            class="w-full bg-gradient-to-r from-red-600 to-red-500 text-white py-3.5 rounded-xl font-semibold text-sm text-center hover:from-red-700 hover:to-red-600 transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Cancel Ride
                    </button>
                    <div id="simulation-status" class="hidden">
                        <div class="bg-gradient-to-br from-zinc-900 to-zinc-800 rounded-xl p-3 shadow-lg">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-1.5">
                                    <div class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse"></div>
                                    <span class="text-emerald-400 text-[10px] font-bold uppercase tracking-wider">Live</span>
                                </div>
                                <div id="step-counter" class="text-zinc-400 text-[10px] font-medium">Step 1/5</div>
                            </div>
                            <div class="relative mb-2">
                                <div class="flex items-center justify-between">
                                    <div id="pickup-indicator" class="w-6 h-6 rounded-full bg-emerald-500/20 flex items-center justify-center border border-emerald-500">
                                        <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                    </div>
                                    <div class="flex-1 mx-2 relative h-1 bg-zinc-700 rounded-full">
                                        <div id="route-progress" class="absolute left-0 top-0 h-full bg-gradient-to-r from-emerald-500 to-emerald-400 rounded-full transition-all duration-1000" style="width: 0%"></div>
                                        <div id="car-icon" class="absolute top-1/2 -translate-y-1/2 transition-all duration-1000" style="left: 0%">
                                            <div class="w-4 h-4 bg-white rounded-full shadow flex items-center justify-center -mt-0.5">
                                                <svg class="w-2.5 h-2.5 text-zinc-800" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="dropoff-indicator" class="w-6 h-6 rounded-full bg-zinc-700 flex items-center justify-center border border-zinc-600">
                                        <svg class="w-3 h-3 text-zinc-500" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <p id="simulation-message" class="text-white text-xs font-medium text-center"></p>
                        </div>
                    </div>
                    <div id="dropoff-notification" class="hidden">
                        <div class="bg-gradient-to-br from-emerald-600 to-emerald-500 rounded-xl p-3 shadow-lg text-white">
                            <div class="flex items-center justify-center gap-2 mb-2">
                                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                                <div>
                                    <p class="font-bold text-sm">At Dropoff!</p>
                                </div>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2 text-center">
                                <p id="dropoff-countdown" class="text-white/90 text-xs font-medium">Stops in 3m 0s</p>
                                <div class="mt-1.5 h-1 bg-white/20 rounded-full overflow-hidden">
                                    <div id="countdown-bar" class="h-full bg-white rounded-full transition-all duration-1000" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a href="/" class="block w-full bg-black text-white py-3 rounded-xl font-semibold text-sm text-center hover:bg-zinc-800 transition-colors">
                        Back to Home
                    </a>
                </div>
            `;
            initCancelRideButton();
        } else {
            contentEl.innerHTML = `
                <div class="glass-panel p-6 rounded-2xl premium-shadow">
                    <div class="flex items-center justify-center py-8">
                        <div class="flex flex-col items-center">
                            <div class="w-14 h-14 bg-zinc-100 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-7 h-7 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                            </div>
                            <span class="text-xs text-zinc-400">Rider</span>
                        </div>
                        
                        <div class="mx-4 flex items-center">
                            <div class="w-2 h-2 bg-zinc-200 rounded-full mx-1"></div>
                            <div class="w-2 h-2 bg-zinc-300 rounded-full mx-1"></div>
                            <div class="w-2 h-2 bg-zinc-200 rounded-full mx-1"></div>
                        </div>
                        
                        <div class="flex flex-col items-center">
                            <div class="w-14 h-14 bg-zinc-100 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-7 h-7 text-zinc-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                </svg>
                            </div>
                            <span class="text-xs text-zinc-400 mt-2">Your Car</span>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <p class="text-base font-semibold text-zinc-800">No active ride</p>
                        <p class="text-sm text-zinc-500 mt-1">Waiting for ride requests...</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mt-6">
                        <button onclick="refreshRide()" class="bg-zinc-100 text-zinc-800 py-3 rounded-xl font-semibold text-sm text-center hover:bg-zinc-200 transition-colors flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            Refresh
                        </button>
                        <a href="/" class="bg-black text-white py-3 rounded-xl font-semibold text-sm text-center hover:bg-zinc-800 transition-colors">
                            Home
                        </a>
                    </div>
                </div>
            `;
        }
        
        loadingEl.classList.add('hidden');
        contentEl.classList.remove('hidden');
    })
    .catch(error => {
        clearInterval(statusInterval);
        console.error('Error fetching ride data:', error);
        const loadingEl = document.getElementById('loading-container');
        loadingEl.innerHTML = `
            <div class="flex flex-col items-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h2 class="text-lg font-bold text-zinc-900 mb-2">Connection Error</h2>
                <p class="text-sm text-zinc-500 mb-4">Failed to fetch ride details. Please try again.</p>
                <a href="/fetch-ride" class="block w-full bg-black text-white py-3 rounded-xl font-semibold text-sm text-center hover:bg-zinc-800 transition-colors">
                    Retry
                </a>
            </div>
        `;
    });

function refreshRide() {
    window.location.reload();
}

let simulationActive = false;
let simulationAborted = false;
let activeCountdownInterval = null;

function stopSimulation() {
    simulationAborted = true;
    simulationActive = false;
    if (activeCountdownInterval) {
        clearInterval(activeCountdownInterval);
        activeCountdownInterval = null;
    }
}

window.addEventListener('beforeunload', stopSimulation);
window.addEventListener('pagehide', stopSimulation);

function initCancelRideButton() {
    const btn = document.getElementById('cancel-ride-btn');
    if (btn) {
        btn.addEventListener('click', startCancelRideSimulation);
    }
}

async function startCancelRideSimulation() {
    simulationActive = true;
    simulationAborted = false;
    const btn = document.getElementById('cancel-ride-btn');
    const statusDiv = document.getElementById('simulation-status');
    const messageEl = document.getElementById('simulation-message');
    const routeProgress = document.getElementById('route-progress');
    const carIcon = document.getElementById('car-icon');
    const stepCounter = document.getElementById('step-counter');
    const dropoffIndicator = document.getElementById('dropoff-indicator');
    const dropoffNotif = document.getElementById('dropoff-notification');
    const countdownEl = document.getElementById('dropoff-countdown');
    const countdownBar = document.getElementById('countdown-bar');
    
    const pickupLat = parseFloat(btn.dataset.pickupLat);
    const pickupLng = parseFloat(btn.dataset.pickupLng);
    const dropoffLat = parseFloat(btn.dataset.dropoffLat);
    const dropoffLng = parseFloat(btn.dataset.dropoffLng);
    
    if (!pickupLat || !pickupLng || !dropoffLat || !dropoffLng) {
        alert('Missing coordinates for route simulation');
        return;
    }
    
    btn.classList.add('hidden');
    statusDiv.classList.remove('hidden');
    
    const numIntermediatePoints = 3 + Math.floor(Math.random() * 2);
    const totalSteps = numIntermediatePoints + 2;
    let currentStep = 0;
    
    const updateProgress = (msg, progress) => {
        currentStep++;
        messageEl.textContent = msg;
        stepCounter.textContent = `Step ${currentStep}/${totalSteps}`;
        const progressPercent = Math.min((currentStep / totalSteps) * 100, 100);
        routeProgress.style.width = `${progressPercent}%`;
        carIcon.style.left = `calc(${progressPercent}% - 8px)`;
    };
    
    const generateRandomOffset = () => {
        return (Math.random() - 0.5) * 0.002;
    };
    
    try {
        updateProgress('Navigating to pickup location...', 0);
        await fetch('/api/cancel-ride-simulation', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({step: 'start', pickup_lat: pickupLat, pickup_lng: pickupLng, dropoff_lat: dropoffLat, dropoff_lng: dropoffLng})
        });
        
        await new Promise(r => setTimeout(r, 5000));
        if (simulationAborted) return;
        
        for (let i = 1; i <= numIntermediatePoints; i++) {
            const progress = i / (numIntermediatePoints + 1);
            const baseLat = pickupLat + (dropoffLat - pickupLat) * progress;
            const baseLng = pickupLng + (dropoffLng - pickupLng) * progress;
            const pointLat = baseLat + generateRandomOffset();
            const pointLng = baseLng + generateRandomOffset();
            
            updateProgress(`Driving to dropoff â€¢ Waypoint ${i}`, progress);
            await fetch('/api/cancel-ride-simulation', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({step: 'intermediate', lat: pointLat, lng: pointLng, point_num: i, dropoff_lat: dropoffLat, dropoff_lng: dropoffLng})
            });
            
            await new Promise(r => setTimeout(r, 5000));
            if (simulationAborted) return;
        }
        
        updateProgress('Arriving at destination...', 1);
        dropoffIndicator.classList.remove('bg-zinc-700', 'border-zinc-600');
        dropoffIndicator.classList.add('bg-emerald-500/20', 'border-emerald-500');
        dropoffIndicator.querySelector('svg').classList.remove('text-zinc-500');
        dropoffIndicator.querySelector('svg').classList.add('text-emerald-500');
        
        await fetch('/api/cancel-ride-simulation', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({step: 'dropoff', dropoff_lat: dropoffLat, dropoff_lng: dropoffLng})
        });
        
        await new Promise(r => setTimeout(r, 2000));
        if (simulationAborted) return;
        
        statusDiv.classList.add('hidden');
        dropoffNotif.classList.remove('hidden');
        
        let countdown = 180;
        const totalCountdown = 180;
        const formatTime = (secs) => {
            const mins = Math.floor(secs / 60);
            const s = secs % 60;
            return mins > 0 ? `${mins}m ${s}s` : `${s}s`;
        };
        
        activeCountdownInterval = setInterval(async () => {
            if (simulationAborted) {
                clearInterval(activeCountdownInterval);
                activeCountdownInterval = null;
                return;
            }
            countdown--;
            countdownEl.textContent = `Location sending stops in ${formatTime(countdown)}`;
            countdownBar.style.width = `${(countdown / totalCountdown) * 100}%`;
            
            if (countdown > 0) {
                await fetch('/api/cancel-ride-simulation', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({step: 'hold_dropoff', dropoff_lat: dropoffLat, dropoff_lng: dropoffLng})
                });
            }
            
            if (countdown <= 0) {
                clearInterval(activeCountdownInterval);
                activeCountdownInterval = null;
                simulationActive = false;
                dropoffNotif.querySelector('.bg-gradient-to-br').innerHTML = `
                    <div class="flex items-center justify-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-white/20 backdrop-blur rounded-full flex items-center justify-center">
                            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-bold text-lg">Simulation Complete</p>
                            <p class="text-emerald-100 text-sm">Location sending stopped</p>
                        </div>
                    </div>
                `;
            }
        }, 1000);
        
    } catch (error) {
        console.error('Error during simulation:', error);
        messageEl.textContent = 'Error: ' + error.message;
        routeProgress.classList.remove('from-emerald-500', 'to-emerald-400');
        routeProgress.classList.add('from-red-500', 'to-red-400');
    }
}

document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        refreshRide();
    }
});

document.addEventListener('DOMContentLoaded', initCancelRideButton);
</script>
{% endif %}
{% endblock %}
