{% extends "base.html" %}

{% block title %}RizTar | Statistics{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-3 sm:px-4 py-4 sm:py-6">
    <div class="flex items-center justify-between mb-4 sm:mb-6">
        <div>
            <h1 class="text-lg sm:text-xl font-bold text-zinc-900">Analytics</h1>
            <p class="text-xs sm:text-sm text-zinc-500">Activity & growth metrics</p>
        </div>
        <a href="{{ url_for('admin') }}" class="p-2 bg-zinc-100 hover:bg-zinc-200 rounded-lg text-zinc-600 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
        </a>
    </div>

    <div id="loadingState" class="text-center py-12">
        <div class="w-8 h-8 border-2 border-zinc-200 border-t-zinc-600 rounded-full animate-spin mx-auto mb-3"></div>
        <p class="text-xs text-zinc-500">Loading...</p>
    </div>

    <div id="statsContent" class="hidden space-y-3 sm:space-y-4">
        <div class="grid grid-cols-4 gap-2 sm:gap-4">
            <div class="glass-panel rounded-lg sm:rounded-xl p-2.5 sm:p-4 premium-shadow text-center">
                <div class="w-7 h-7 sm:w-9 sm:h-9 bg-gradient-to-br from-blue-500 to-blue-600 rounded-md sm:rounded-lg flex items-center justify-center mx-auto mb-1.5 sm:mb-2">
                    <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </div>
                <p class="text-base sm:text-xl font-bold text-zinc-900" id="visitsToday">0</p>
                <p class="text-[9px] sm:text-[10px] text-zinc-400 mt-0.5">Today</p>
            </div>

            <div class="glass-panel rounded-lg sm:rounded-xl p-2.5 sm:p-4 premium-shadow text-center">
                <div class="w-7 h-7 sm:w-9 sm:h-9 bg-gradient-to-br from-purple-500 to-purple-600 rounded-md sm:rounded-lg flex items-center justify-center mx-auto mb-1.5 sm:mb-2">
                    <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </div>
                <p class="text-base sm:text-xl font-bold text-zinc-900" id="visitsWeek">0</p>
                <p class="text-[9px] sm:text-[10px] text-zinc-400 mt-0.5">Week</p>
            </div>

            <div class="glass-panel rounded-lg sm:rounded-xl p-2.5 sm:p-4 premium-shadow text-center">
                <div class="w-7 h-7 sm:w-9 sm:h-9 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-md sm:rounded-lg flex items-center justify-center mx-auto mb-1.5 sm:mb-2">
                    <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <p class="text-base sm:text-xl font-bold text-zinc-900" id="visitsMonth">0</p>
                <p class="text-[9px] sm:text-[10px] text-zinc-400 mt-0.5">Month</p>
            </div>

            <div class="glass-panel rounded-lg sm:rounded-xl p-2.5 sm:p-4 premium-shadow text-center">
                <div class="w-7 h-7 sm:w-9 sm:h-9 bg-gradient-to-br from-zinc-600 to-zinc-700 rounded-md sm:rounded-lg flex items-center justify-center mx-auto mb-1.5 sm:mb-2">
                    <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                    </svg>
                </div>
                <p class="text-base sm:text-xl font-bold text-zinc-900" id="visitsTotal">0</p>
                <p class="text-[9px] sm:text-[10px] text-zinc-400 mt-0.5">Total</p>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-2 sm:gap-4">
            <div class="glass-panel rounded-lg sm:rounded-xl p-3 sm:p-4 premium-shadow">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-6 h-6 sm:w-8 sm:h-8 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-md flex items-center justify-center">
                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                    </div>
                </div>
                <p class="text-lg sm:text-2xl font-bold text-zinc-900" id="totalUsers">0</p>
                <p class="text-[10px] sm:text-xs text-zinc-500">Users</p>
                <div class="flex gap-2 mt-2 pt-2 border-t border-zinc-100">
                    <div class="flex-1">
                        <p class="text-xs sm:text-sm font-semibold text-zinc-700" id="usersToday">0</p>
                        <p class="text-[8px] sm:text-[10px] text-zinc-400">today</p>
                    </div>
                    <div class="flex-1">
                        <p class="text-xs sm:text-sm font-semibold text-zinc-700" id="usersWeek">0</p>
                        <p class="text-[8px] sm:text-[10px] text-zinc-400">week</p>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-lg sm:rounded-xl p-3 sm:p-4 premium-shadow">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-6 h-6 sm:w-8 sm:h-8 bg-gradient-to-br from-amber-500 to-orange-500 rounded-md flex items-center justify-center">
                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                </div>
                <p class="text-lg sm:text-2xl font-bold text-zinc-900" id="uberConnected">0</p>
                <p class="text-[10px] sm:text-xs text-zinc-500">Connected</p>
                <div class="mt-2 pt-2 border-t border-zinc-100">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-[8px] sm:text-[10px] text-zinc-400">Rate</span>
                        <span class="text-[10px] sm:text-xs font-medium text-zinc-600" id="connectionRate">0%</span>
                    </div>
                    <div class="w-full bg-zinc-100 rounded-full h-1">
                        <div class="bg-gradient-to-r from-amber-500 to-orange-400 h-1 rounded-full transition-all duration-500" id="connectionBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-lg sm:rounded-xl p-3 sm:p-4 premium-shadow">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-6 h-6 sm:w-8 sm:h-8 bg-gradient-to-br from-rose-500 to-pink-500 rounded-md flex items-center justify-center">
                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                        </svg>
                    </div>
                </div>
                <p class="text-lg sm:text-2xl font-bold text-zinc-900" id="growthRate">0%</p>
                <p class="text-[10px] sm:text-xs text-zinc-500">Growth</p>
                <div class="mt-2 pt-2 border-t border-zinc-100">
                    <div class="flex items-center gap-0.5">
                        <svg class="w-3 h-3 text-emerald-500" id="growthIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                        </svg>
                        <span class="text-[8px] sm:text-[10px] text-zinc-400">vs last week</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-panel rounded-lg sm:rounded-xl p-3 sm:p-5 premium-shadow">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <h3 class="text-xs sm:text-sm font-semibold text-zinc-900">Page Visits</h3>
                    <p class="text-[10px] sm:text-xs text-zinc-400">Last 30 days</p>
                </div>
                <div class="flex items-center gap-1.5">
                    <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                    <span class="text-[10px] text-zinc-400 hidden sm:inline">Daily</span>
                </div>
            </div>
            <div class="h-40 sm:h-56">
                <canvas id="visitsChart"></canvas>
            </div>
        </div>

        <div class="glass-panel rounded-lg sm:rounded-xl p-3 sm:p-5 premium-shadow">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <h3 class="text-xs sm:text-sm font-semibold text-zinc-900">New Signups</h3>
                    <p class="text-[10px] sm:text-xs text-zinc-400">Last 30 days</p>
                </div>
                <div class="flex items-center gap-1.5">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full"></span>
                    <span class="text-[10px] text-zinc-400 hidden sm:inline">Daily</span>
                </div>
            </div>
            <div class="h-40 sm:h-56">
                <canvas id="signupsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let visitsChart, signupsChart;

async function loadStatistics() {
    try {
        const response = await fetch('/api/statistics');
        const data = await response.json();
        
        if (data.error) {
            console.error(data.error);
            return;
        }
        
        document.getElementById('visitsToday').textContent = data.visits.today.toLocaleString();
        document.getElementById('visitsWeek').textContent = data.visits.week.toLocaleString();
        document.getElementById('visitsMonth').textContent = data.visits.month.toLocaleString();
        document.getElementById('visitsTotal').textContent = data.visits.total.toLocaleString();
        
        document.getElementById('totalUsers').textContent = data.users.total.toLocaleString();
        document.getElementById('usersToday').textContent = data.users.today.toLocaleString();
        document.getElementById('usersWeek').textContent = data.users.week.toLocaleString();
        
        document.getElementById('uberConnected').textContent = data.uber_connected.toLocaleString();
        
        const connectionRate = data.users.total > 0 ? Math.round((data.uber_connected / data.users.total) * 100) : 0;
        document.getElementById('connectionRate').textContent = connectionRate + '%';
        document.getElementById('connectionBar').style.width = connectionRate + '%';
        
        const lastWeekVisits = data.daily_visits.slice(-14, -7).reduce((sum, d) => sum + d.count, 0);
        const thisWeekVisits = data.daily_visits.slice(-7).reduce((sum, d) => sum + d.count, 0);
        let growthRate = 0;
        if (lastWeekVisits > 0) {
            growthRate = Math.round(((thisWeekVisits - lastWeekVisits) / lastWeekVisits) * 100);
        } else if (thisWeekVisits > 0) {
            growthRate = 100;
        }
        document.getElementById('growthRate').textContent = (growthRate >= 0 ? '+' : '') + growthRate + '%';
        
        const labels = data.daily_visits.map(d => d.date);
        const visitCounts = data.daily_visits.map(d => d.count);
        const signupCounts = data.daily_signups.map(d => d.count);
        
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { 
                        font: { size: 9 },
                        color: '#a1a1aa',
                        maxTicksLimit: 5
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: '#f4f4f5' },
                    ticks: { 
                        font: { size: 9 },
                        color: '#a1a1aa',
                        stepSize: 1
                    }
                }
            },
            elements: {
                line: { tension: 0.4, borderWidth: 2 },
                point: { radius: 0, hoverRadius: 3 }
            }
        };
        
        const visitsCtx = document.getElementById('visitsChart').getContext('2d');
        visitsChart = new Chart(visitsCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    data: visitCounts,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.08)',
                    fill: true
                }]
            },
            options: chartOptions
        });
        
        const signupsCtx = document.getElementById('signupsChart').getContext('2d');
        signupsChart = new Chart(signupsCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    data: signupCounts,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.08)',
                    fill: true
                }]
            },
            options: chartOptions
        });
        
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('statsContent').classList.remove('hidden');
        
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

document.addEventListener('DOMContentLoaded', loadStatistics);
</script>
{% endblock %}
