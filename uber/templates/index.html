{% extends "base.html" %}

{% block title %}RizTar | Location{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
.pulse-ring {
    animation: pulse-ring 2s infinite ease-out;
}
@keyframes pulse-ring {
    0% { transform: scale(1); opacity: 0.4; }
    100% { transform: scale(1.5); opacity: 0; }
}
@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}
.skeleton {
    background: linear-gradient(90deg, #3f3f46 25%, #52525b 50%, #3f3f46 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}
.skeleton-light {
    background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}
#map {
    height: 300px;
    width: 100%;
    border-radius: 16px;
    z-index: 1;
}
.leaflet-container img {
    max-width: none !important;
    max-height: none !important;
}
.leaflet-control-zoom {
    border: none !important;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1) !important;
}
.leaflet-control-zoom a {
    background: white !important;
    color: #18181b !important;
    border: none !important;
    width: 36px !important;
    height: 36px !important;
    line-height: 36px !important;
    font-size: 18px !important;
}
.leaflet-control-zoom a:hover {
    background: #f4f4f5 !important;
}
.map-overlay {
    position: absolute;
    bottom: 12px;
    left: 12px;
    right: 12px;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 12px 16px;
    z-index: 1000;
}
.coord-display {
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
    font-size: 11px;
}
@keyframes marker-pulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.4); }
    50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(0, 0, 0, 0); }
}
.custom-marker {
    background: #000;
    border: 3px solid #fff;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    animation: marker-pulse 2s infinite;
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-[80vh] px-4 py-8">
    <div id="container" class="w-full max-w-lg mx-auto">
        
        {% if loading %}
        <div id="loading-skeleton">
            <div class="bg-gradient-to-b from-zinc-900 to-zinc-800 rounded-t-2xl p-6 text-center">
                <div class="w-48 h-28 skeleton rounded-lg mx-auto"></div>
                <div class="h-4 w-32 skeleton rounded mt-3 mx-auto"></div>
                <div class="h-3 w-24 skeleton rounded mt-2 mx-auto"></div>
            </div>
            <div class="bg-white rounded-b-2xl shadow-xl p-6">
                <div class="h-[300px] skeleton-light rounded-xl mb-4"></div>
                <div class="h-12 skeleton-light rounded-xl mb-3"></div>
                <div class="h-12 skeleton-light rounded-xl"></div>
            </div>
        </div>
        <div id="location-content" class="hidden"></div>
        {% elif not has_permission %}
        <div class="glass-panel p-6 rounded-xl premium-shadow text-center">
            <div class="w-16 h-16 bg-zinc-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
            </div>
            <h2 class="text-lg font-bold text-zinc-900 mb-2">Access Locked</h2>
            <p class="text-sm text-zinc-500 mb-5">You don't have permission to change location. Contact an administrator to request access.</p>
            <a href="{{ url_for('root') }}" class="block w-full bg-black text-white py-3 rounded-lg font-medium text-sm hover:bg-zinc-800 transition-colors">
                Back to Home
            </a>
        </div>
        {% else %}
        <div id="searchState">
            {% if default_vehicle %}
            <div class="bg-gradient-to-b from-zinc-900 to-zinc-800 rounded-t-2xl p-5 text-center">
                <div class="relative inline-block">
                    {% if default_vehicle.imageUrl %}
                    <img src="{{ default_vehicle.imageUrl }}" alt="{{ default_vehicle.make }} {{ default_vehicle.model }}" 
                        class="w-40 h-24 object-contain mx-auto drop-shadow-2xl">
                    {% else %}
                    <div class="w-40 h-24 bg-zinc-700 rounded-lg flex items-center justify-center mx-auto">
                        <svg class="w-16 h-16 text-zinc-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                        </svg>
                    </div>
                    {% endif %}
                </div>
                <p class="text-white font-semibold mt-2">{{ default_vehicle.make }} {{ default_vehicle.model }}</p>
                <p class="text-zinc-400 text-xs">{{ default_vehicle.year }} Â· {{ default_vehicle.licensePlate }}</p>
            </div>
            {% endif %}
            
            <div class="bg-white {% if default_vehicle %}rounded-b-2xl{% else %}rounded-2xl{% endif %} shadow-xl p-5">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-black rounded-full flex items-center justify-center mr-3">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-zinc-900">Change Location</h2>
                            <p class="text-xs text-zinc-500">Tap map or enter address</p>
                        </div>
                    </div>
                    <button id="locateMeBtn" class="p-2.5 bg-zinc-100 rounded-xl hover:bg-zinc-200 transition-colors" title="Use my location">
                        <svg class="w-5 h-5 text-zinc-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                </div>
                
                <div class="relative mb-4">
                    <div id="map" class="border border-zinc-200 shadow-inner"></div>
                    <div id="mapOverlay" class="map-overlay hidden">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white/60 text-[10px] uppercase tracking-wide mb-0.5">Selected Location</p>
                                <p id="coordDisplay" class="text-white coord-display">-31.9505, 115.8605</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="clearMapBtn" class="p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 mb-4">
                    <div class="flex-1 h-px bg-zinc-200"></div>
                    <span class="text-xs text-zinc-400 px-2">or search by address</span>
                    <div class="flex-1 h-px bg-zinc-200"></div>
                </div>
                
                <div class="space-y-3">
                    <div class="relative">
                        <input type="text" id="destinationInput" 
                            class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black focus:ring-2 focus:ring-black/5 transition-all pr-10"
                            placeholder="Enter address, suburb or city">
                        <svg class="w-5 h-5 text-zinc-400 absolute right-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                    
                    <button id="searchBtn" 
                        class="w-full bg-black text-white py-3.5 rounded-xl font-semibold text-sm hover:bg-zinc-800 transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        </svg>
                        Update Location
                    </button>
                </div>
                
                <div id="quickLocations" class="mt-4 pt-4 border-t border-zinc-100">
                    <p class="text-xs text-zinc-400 mb-2">Quick locations</p>
                    <div class="flex flex-wrap gap-2">
                        <button class="quick-loc px-3 py-1.5 bg-zinc-100 hover:bg-zinc-200 rounded-full text-xs font-medium text-zinc-700 transition-colors" data-lat="-31.9505" data-lng="115.8605">Perth CBD</button>
                        <button class="quick-loc px-3 py-1.5 bg-zinc-100 hover:bg-zinc-200 rounded-full text-xs font-medium text-zinc-700 transition-colors" data-lat="-31.9403" data-lng="115.9670">Perth Airport</button>
                        <button class="quick-loc px-3 py-1.5 bg-zinc-100 hover:bg-zinc-200 rounded-full text-xs font-medium text-zinc-700 transition-colors" data-lat="-32.0569" data-lng="115.7445">Fremantle</button>
                        <button class="quick-loc px-3 py-1.5 bg-zinc-100 hover:bg-zinc-200 rounded-full text-xs font-medium text-zinc-700 transition-colors" data-lat="-31.8963" data-lng="115.8008">Scarborough</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="pulsingState" class="hidden">
            {% if default_vehicle %}
            <div class="bg-gradient-to-b from-zinc-900 to-zinc-800 rounded-t-2xl p-6 text-center">
                {% if default_vehicle.imageUrl %}
                <img src="{{ default_vehicle.imageUrl }}" alt="Vehicle" class="w-40 h-24 object-contain mx-auto drop-shadow-2xl">
                {% endif %}
                <p class="text-white font-semibold mt-2">{{ default_vehicle.make }} {{ default_vehicle.model }}</p>
            </div>
            {% endif %}
            
            <div class="bg-white rounded-b-2xl shadow-xl p-8 {% if not default_vehicle %}rounded-t-2xl{% endif %}">
                <div class="flex flex-col items-center justify-center">
                    <div class="relative flex items-center justify-center mb-6">
                        <div class="pulse-ring absolute w-24 h-24 bg-black rounded-full opacity-20"></div>
                        <div class="pulse-ring absolute w-32 h-32 bg-black rounded-full opacity-10" style="animation-delay: 0.5s"></div>
                        
                        <button id="stopBtn" 
                            class="relative z-10 w-20 h-20 bg-black text-white rounded-full font-semibold text-sm shadow-lg flex items-center justify-center hover:bg-zinc-800 transition-colors">
                            Stop
                        </button>
                    </div>
                    
                    <p class="text-base font-semibold text-zinc-900">Updating location...</p>
                    <p id="destinationDisplay" class="text-sm text-zinc-500 mt-1"></p>
                </div>
            </div>
        </div>
        
        <div id="flightCenter" class="mt-6">
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-blue-500 px-5 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-white font-bold text-base">Flight Center</h3>
                                <p class="text-blue-100 text-xs">Perth Airport Arrivals</p>
                            </div>
                        </div>
                        <div id="flightTotal" class="text-right">
                            <p class="text-white/80 text-xs">Total Flights</p>
                            <p class="text-white font-bold text-lg">--</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-4">
                    <div id="flightGrid" class="grid grid-cols-6 gap-1.5">
                        {% for hour in range(24) %}
                        <div class="flight-hour bg-zinc-50 rounded-lg p-2 text-center hover:bg-zinc-100 transition-colors cursor-pointer" data-hour="{{ hour }}">
                            <p class="text-zinc-400 text-[10px] font-medium">{{ '%02d' % hour }}:00</p>
                            <p class="text-zinc-900 font-bold text-sm flight-count">-</p>
                        </div>
                        {% endfor %}
                    </div>
                    <p class="text-zinc-400 text-xs text-center mt-3">Flights per hour (24h schedule)</p>
                </div>
            </div>
        </div>
        
        {% if uber_connected %}
        <div id="userProfileSection" class="mt-6">
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="bg-gradient-to-r from-zinc-800 to-zinc-900 px-5 py-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-full flex items-center justify-center shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-white font-bold text-base" id="profileDisplayName">{{ username }}</h3>
                            <div class="flex items-center gap-1.5 mt-0.5">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-emerald-500/20 text-emerald-400">
                                    <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full mr-1"></span>
                                    Uber Connected
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div id="profileDetails" class="space-y-2 mb-4">
                        <div class="flex items-center text-sm text-zinc-600">
                            <svg class="w-4 h-4 mr-2 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            <span id="profileEmail">Loading...</span>
                        </div>
                        <div class="flex items-center text-sm text-zinc-600">
                            <svg class="w-4 h-4 mr-2 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                            <span id="profilePhone">Loading...</span>
                        </div>
                    </div>
                    <button id="disconnectBtn" 
                        class="w-full bg-red-50 border border-red-200 text-red-600 py-3 rounded-xl font-semibold text-sm hover:bg-red-100 transition-colors flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        Disconnect Uber Account
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}
    </div>
</div>

{% if disconnect_form %}
<div id="disconnectModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden">
        <div class="bg-gradient-to-r from-red-500 to-red-600 px-6 py-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h3 class="text-white font-bold text-lg">Disconnect Account</h3>
            </div>
        </div>
        <div class="p-6">
            <p class="text-zinc-600 text-sm mb-6">Are you sure you want to disconnect your Uber account? You'll need to reconnect to use driver features.</p>
            <div class="flex gap-3">
                <button id="cancelDisconnect" class="flex-1 bg-zinc-100 text-zinc-700 py-3 rounded-xl font-semibold text-sm hover:bg-zinc-200 transition-colors">
                    Cancel
                </button>
                <form action="{{ url_for('uber_disconnect') }}" method="POST" class="flex-1">
                    {{ disconnect_form.hidden_tag() }}
                    <button type="submit" class="w-full bg-red-500 text-white py-3 rounded-xl font-semibold text-sm hover:bg-red-600 transition-colors">
                        Disconnect
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
{% if loading %}
<script>
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

fetch('/api/location-data')
    .then(response => response.json())
    .then(data => {
        const loadingEl = document.getElementById('loading-skeleton');
        const contentEl = document.getElementById('location-content');
        
        loadingEl.classList.add('hidden');
        contentEl.classList.remove('hidden');
        
        const driver = data.driver_info;
        if (driver) {
            const profileName = document.getElementById('profileDisplayName');
            const profileEmail = document.getElementById('profileEmail');
            const profilePhone = document.getElementById('profilePhone');
            
            if (profileName && driver.name) profileName.textContent = driver.name;
            if (profileEmail) profileEmail.textContent = driver.email || 'Not available';
            if (profilePhone) profilePhone.textContent = driver.phone || 'Not available';
        }
        
        initMapAndHandlers();
    })
    .catch(error => {
        console.error('Error loading location data:', error);
        document.getElementById('loading-skeleton').innerHTML = `
            <div class="glass-panel p-6 rounded-xl premium-shadow text-center">
                <p class="text-zinc-500">Failed to load. <a href="/change-location" class="text-black underline">Retry</a></p>
            </div>
        `;
    });
</script>
{% endif %}

{% if has_permission %}
<script>
let map, marker;
let selectedLat = null, selectedLng = null;
let locationLoopActive = false;

async function stopLocationLoop() {
    if (locationLoopActive) {
        try {
            await fetch('/stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            });
        } catch (e) { console.error(e); }
        locationLoopActive = false;
    }
}

window.addEventListener('beforeunload', stopLocationLoop);
window.addEventListener('pagehide', stopLocationLoop);

function initMapAndHandlers() {
    initMap();
    initLocationHandlers();
    loadFlightData();
    initDisconnectModal();
}

function initMap() {
    const mapContainer = document.getElementById('map');
    if (!mapContainer) return;
    
    map = L.map('map', {
        zoomControl: true,
        attributionControl: false
    }).setView([-31.9505, 115.8605], 12);
    
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    
    setTimeout(function() {
        map.invalidateSize();
    }, 100);
    
    map.on('click', function(e) {
        setMarker(e.latlng.lat, e.latlng.lng);
    });
    
    document.querySelectorAll('.quick-loc').forEach(btn => {
        btn.addEventListener('click', function() {
            const lat = parseFloat(this.dataset.lat);
            const lng = parseFloat(this.dataset.lng);
            setMarker(lat, lng);
            map.setView([lat, lng], 14);
        });
    });
    
    const locateMeBtn = document.getElementById('locateMeBtn');
    if (locateMeBtn) {
        locateMeBtn.addEventListener('click', function() {
            if (navigator.geolocation) {
                this.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"></circle><path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill="currentColor" class="opacity-75"></path></svg>';
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        setMarker(pos.coords.latitude, pos.coords.longitude);
                        map.setView([pos.coords.latitude, pos.coords.longitude], 15);
                        this.innerHTML = '<svg class="w-5 h-5 text-zinc-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>';
                    },
                    (err) => {
                        console.error('Geolocation error:', err);
                        this.innerHTML = '<svg class="w-5 h-5 text-zinc-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>';
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            }
        });
    }
    
    const clearMapBtn = document.getElementById('clearMapBtn');
    if (clearMapBtn) {
        clearMapBtn.addEventListener('click', function() {
            clearMarker();
        });
    }
}

function setMarker(lat, lng) {
    selectedLat = lat;
    selectedLng = lng;
    
    if (marker) {
        map.removeLayer(marker);
    }
    
    const customIcon = L.divIcon({
        className: 'custom-marker-container',
        html: '<div class="custom-marker"></div>',
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });
    
    marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
    
    const overlay = document.getElementById('mapOverlay');
    const coordDisplay = document.getElementById('coordDisplay');
    overlay.classList.remove('hidden');
    coordDisplay.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    
    document.getElementById('destinationInput').value = '';
}

function clearMarker() {
    if (marker) {
        map.removeLayer(marker);
        marker = null;
    }
    selectedLat = null;
    selectedLng = null;
    document.getElementById('mapOverlay').classList.add('hidden');
}

function initLocationHandlers() {
    const searchState = document.getElementById('searchState');
    const pulsingState = document.getElementById('pulsingState');
    const searchBtn = document.getElementById('searchBtn');
    const stopBtn = document.getElementById('stopBtn');
    const destinationInput = document.getElementById('destinationInput');
    const destinationDisplay = document.getElementById('destinationDisplay');

    if (!searchBtn) return;

    searchBtn.addEventListener('click', async () => {
        let destination = destinationInput.value.trim();
        
        if (selectedLat !== null && selectedLng !== null && !destination) {
            destination = `${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;
        }
        
        if (!destination) {
            destinationInput.style.borderColor = '#ef4444';
            destinationInput.placeholder = 'Tap on map or enter address';
            return;
        }
        
        destinationInput.style.borderColor = '';
        destinationDisplay.textContent = destination;
        
        searchState.classList.add('hidden');
        pulsingState.classList.remove('hidden');
        locationLoopActive = true;
        
        try {
            await fetch('/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `destination=${encodeURIComponent(destination)}`
            });
        } catch (e) { console.error(e); }
    });

    if (stopBtn) {
        stopBtn.addEventListener('click', async () => {
            locationLoopActive = false;
            try {
                await fetch('/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                });
            } catch (e) { console.error(e); }

            pulsingState.classList.add('hidden');
            searchState.classList.remove('hidden');
            destinationInput.value = '';
            clearMarker();
        });
    }

    destinationInput.addEventListener('input', () => {
        destinationInput.style.borderColor = '';
        if (destinationInput.value.trim()) {
            clearMarker();
        }
    });
}

function loadFlightData() {
    fetch('/api/flight-arrivals')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                data.hourly_flights.forEach(hourData => {
                    const hourEl = document.querySelector(`.flight-hour[data-hour="${hourData.hour}"]`);
                    if (hourEl) {
                        const countEl = hourEl.querySelector('.flight-count');
                        countEl.textContent = hourData.count;
                        if (hourData.count > 5) {
                            hourEl.classList.remove('bg-zinc-50');
                            hourEl.classList.add('bg-blue-50');
                            countEl.classList.add('text-blue-600');
                        } else if (hourData.count > 0) {
                            hourEl.classList.remove('bg-zinc-50');
                            hourEl.classList.add('bg-emerald-50');
                            countEl.classList.add('text-emerald-600');
                        }
                    }
                });
                const totalEl = document.querySelector('#flightTotal p:last-child');
                if (totalEl) totalEl.textContent = data.total_flights;
            }
        })
        .catch(error => console.error('Error loading flight data:', error));
}

function initDisconnectModal() {
    const disconnectBtn = document.getElementById('disconnectBtn');
    const disconnectModal = document.getElementById('disconnectModal');
    const cancelDisconnect = document.getElementById('cancelDisconnect');
    
    if (disconnectBtn && disconnectModal) {
        disconnectBtn.addEventListener('click', () => {
            disconnectModal.classList.remove('hidden');
        });
    }
    
    if (cancelDisconnect && disconnectModal) {
        cancelDisconnect.addEventListener('click', () => {
            disconnectModal.classList.add('hidden');
        });
    }
    
    if (disconnectModal) {
        disconnectModal.addEventListener('click', (e) => {
            if (e.target === disconnectModal) {
                disconnectModal.classList.add('hidden');
            }
        });
    }
}

{% if not loading %}
document.addEventListener('DOMContentLoaded', function() {
    initMapAndHandlers();
});
{% endif %}
</script>
{% endif %}
{% endblock %}
