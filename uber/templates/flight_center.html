{% extends "base.html" %}

{% block title %}Flight Center - RizTar{% endblock %}

{% block extra_styles %}
<style>
    .hour-card { transition: all 0.2s ease; }
    .hour-card:hover { transform: translateY(-2px); }
    .hour-low { background: linear-gradient(135deg, #f4f4f5 0%, #e4e4e7 100%); }
    .hour-medium { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
    .hour-high { background: linear-gradient(135deg, #bbf7d0 0%, #86efac 100%); }
    .hour-busy { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
    .airline-dot {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 7px;
        font-weight: 700;
        color: white;
    }
    .skeleton-pulse {
        background: linear-gradient(90deg, #f4f4f5 0%, #fafafa 50%, #f4f4f5 100%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">
    <div class="glass-panel rounded-xl premium-shadow overflow-hidden">
        <div class="bg-black px-5 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 bg-white/10 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-white font-bold">Flight Center</h1>
                        <p class="text-zinc-400 text-xs">Perth Airport Arrivals</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <select id="terminalFilter" class="text-xs bg-white/10 border-0 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-white/20">
                        <option value="" class="text-zinc-900">All Terminals</option>
                    </select>
                    <div class="text-right px-2">
                        <p class="text-zinc-400 text-[10px]">PERTH</p>
                        <p id="currentTime" class="text-white font-bold text-sm">--:--</p>
                    </div>
                    <button onclick="refreshFlights()" class="p-2 bg-white/10 rounded-lg hover:bg-white/20 transition-colors">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="loadingSkeleton" class="p-4 grid grid-cols-2 md:grid-cols-3 gap-3">
            <div class="skeleton-pulse h-24 rounded-xl"></div>
            <div class="skeleton-pulse h-24 rounded-xl"></div>
            <div class="skeleton-pulse h-24 rounded-xl"></div>
            <div class="skeleton-pulse h-24 rounded-xl"></div>
            <div class="skeleton-pulse h-24 rounded-xl"></div>
            <div class="skeleton-pulse h-24 rounded-xl"></div>
        </div>

        <div id="hoursContainer" class="hidden p-4 grid grid-cols-2 md:grid-cols-3 gap-3"></div>

        <div id="noFlights" class="hidden text-center py-10">
            <svg class="w-12 h-12 mx-auto text-zinc-200 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
            </svg>
            <p class="text-zinc-400 text-sm">No flights available</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const airlineColors = {
    'QF': '#e31837', 'VA': '#e4002b', 'JQ': '#ff6d00', 'SQ': '#f4c300',
    'EK': '#d71921', 'CX': '#006564', 'MH': '#0033a0', 'NZ': '#000000',
    'TR': '#b8203b', 'AK': '#e31937', 'GA': '#00467f', 'PR': '#0033a0',
    'CZ': '#0066b3', 'AA': '#0078d2', 'UA': '#002244', 'DL': '#e31837'
};

function getAirlineColor(code) {
    return airlineColors[code.substring(0, 2)] || '#18181b';
}

function getHourClass(count) {
    if (count === 0) return 'hour-low';
    if (count <= 3) return 'hour-medium';
    if (count <= 6) return 'hour-high';
    return 'hour-busy';
}

function updateCurrentTime() {
    const now = new Date();
    const perthTime = new Date(now.toLocaleString('en-US', { timeZone: 'Australia/Perth' }));
    document.getElementById('currentTime').textContent = 
        perthTime.getHours().toString().padStart(2, '0') + ':' + 
        perthTime.getMinutes().toString().padStart(2, '0');
}

let flightData = null;

function loadFlights(terminal = '') {
    document.getElementById('loadingSkeleton').classList.remove('hidden');
    document.getElementById('hoursContainer').classList.add('hidden');
    document.getElementById('noFlights').classList.add('hidden');
    
    const renderFlights = () => {
        document.getElementById('loadingSkeleton').classList.add('hidden');
        
        if (!flightData || !flightData.flights_by_terminal) {
            document.getElementById('noFlights').classList.remove('hidden');
            return;
        }
        
        const terminalFilter = document.getElementById('terminalFilter');
        if (terminalFilter && terminalFilter.options.length <= 1) {
            Object.keys(flightData.flights_by_terminal).sort().forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = `Terminal ${t}`;
                opt.className = 'text-zinc-900';
                terminalFilter.appendChild(opt);
            });
        }
        
        const allFlights = [];
        if (terminal) {
            const flights = flightData.flights_by_terminal[terminal] || [];
            flights.forEach(f => allFlights.push(f));
        } else {
            Object.values(flightData.flights_by_terminal).forEach(flights => {
                flights.forEach(f => allFlights.push(f));
            });
        }
            
            const hourlyData = {};
            allFlights.forEach(flight => {
                const hour = parseInt(flight.time.split(':')[0]);
                if (!hourlyData[hour]) {
                    hourlyData[hour] = { count: 0, airlines: [] };
                }
                hourlyData[hour].count++;
                const airline = flight.flight.substring(0, 2);
                if (!hourlyData[hour].airlines.includes(airline)) {
                    hourlyData[hour].airlines.push(airline);
                }
            });
            
            const container = document.getElementById('hoursContainer');
            container.innerHTML = '';
            
            const hours = Object.keys(hourlyData).map(Number).sort((a, b) => a - b);
            
            if (hours.length === 0) {
                document.getElementById('noFlights').classList.remove('hidden');
                return;
            }
            
            hours.forEach(hour => {
                const info = hourlyData[hour];
                const displayAirlines = info.airlines.slice(0, Math.min(4, info.count));
                
                let airlinesHtml = displayAirlines.map(a => 
                    `<div class="airline-dot" style="background-color: ${getAirlineColor(a)}">${a}</div>`
                ).join('');
                
                if (info.count > displayAirlines.length) {
                    airlinesHtml += `<div class="airline-dot bg-zinc-400">+${info.count - displayAirlines.length}</div>`;
                }
                
                const cardHtml = `
                    <div class="hour-card ${getHourClass(info.count)} rounded-xl p-4 cursor-default">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <p class="text-xs text-zinc-500 font-medium">${hour.toString().padStart(2, '0')}:00</p>
                                <p class="text-2xl font-bold text-zinc-900">${info.count}</p>
                                <p class="text-[10px] text-zinc-500">flight${info.count !== 1 ? 's' : ''}</p>
                            </div>
                            <svg class="w-5 h-5 text-zinc-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                            </svg>
                        </div>
                        <div class="flex gap-1 flex-wrap">
                            ${airlinesHtml}
                        </div>
                    </div>
                `;
                
                container.innerHTML += cardHtml;
            });
            
            container.classList.remove('hidden');
    };
    
    if (flightData) {
        renderFlights();
    } else {
        fetch('/api/flight-details')
            .then(response => response.json())
            .then(data => {
                flightData = data;
                renderFlights();
            })
            .catch(error => {
                console.error('Error loading flights:', error);
                document.getElementById('loadingSkeleton').classList.add('hidden');
                document.getElementById('noFlights').classList.remove('hidden');
            });
    }
}

function refreshFlights() {
    flightData = null;
    const filter = document.getElementById('terminalFilter');
    loadFlights(filter ? filter.value : '');
}

document.getElementById('terminalFilter').addEventListener('change', function() {
    loadFlights(this.value);
});

updateCurrentTime();
setInterval(updateCurrentTime, 30000);
loadFlights();
</script>
{% endblock %}
